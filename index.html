<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#151436"/>
<title>Fitness Log</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon-192.png">
<style>
:root{
  --bg:#151436;
  --bg2:#0f1230;
  --card:#1a1f45;
  --card2:#20285a;
  --text:#f6f7ff;
  --muted:rgba(246,247,255,.75);
  --line:rgba(255,255,255,.10);
  --shadow:0 18px 55px rgba(0,0,0,.45);
  --r:22px;
  --r2:16px;
  --gradHeader:linear-gradient(135deg,#0f1a56 0%, #2e1b6f 45%, #ff3b3b 100%);
  --gradOrange:linear-gradient(135deg,#ff512f 0%, #f09819 100%);
  --gradBlue:linear-gradient(135deg,#00c6ff 0%, #0072ff 100%);
  --gradGreen:linear-gradient(135deg,#00b09b 0%, #96c93d 100%);
  --gradRed:linear-gradient(135deg,#ff416c 0%, #ff4b2b 100%);
  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;

  --safeTop:env(safe-area-inset-top,0px);
  --safeBot:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box}
html,body{height:100%;overscroll-behavior:none}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background: radial-gradient(1200px 800px at 50% -10%, rgba(255,81,47,.25), transparent 55%),
             radial-gradient(1200px 800px at 0% 0%, rgba(106,17,203,.22), transparent 55%),
             linear-gradient(180deg, #2b1b55 0%, var(--bg) 35%, var(--bg2) 100%);
  -webkit-font-smoothing:antialiased;
}
.app{min-height:100dvh;display:flex;justify-content:center;padding:12px 12px calc(12px + var(--safeBot)); padding-top:calc(10px + var(--safeTop))}
.phone{width:min(430px,100%);display:flex;flex-direction:column;gap:12px}
.header{
  border-radius:28px;
  overflow:hidden;
  box-shadow:var(--shadow);
  border:1px solid rgba(255,255,255,.12);
  background:var(--gradHeader);
}
.headerInner{
  padding:14px 14px 12px;
}
.headerTop{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.hIconBtn{
  width:38px;height:38px;border-radius:14px;border:1px solid rgba(255,255,255,.20);
  background:rgba(0,0,0,.12);
  display:grid;place-items:center;
  cursor:pointer;
}
.hTitle{font-weight:950;font-size:22px;letter-spacing:-.02em;line-height:1}
.hSub{margin-top:6px;color:rgba(255,255,255,.82);font-weight:800}
.card{
  background:rgba(20,24,60,.72);
  border:1px solid rgba(255,255,255,.12);
  border-radius:28px;
  box-shadow:var(--shadow);
}
.sectionPad{padding:14px}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.stat{
  border-radius:18px;
  padding:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  position:relative;
  overflow:hidden;
  cursor:pointer;
  min-height:92px;
}
.stat::after{
  content:"";
  position:absolute;inset:-10px;
  opacity:.55;
  filter:blur(22px);
  transform:translateY(35px);
}
.stat.weight::after{background:var(--gradBlue)}
.stat.meals::after{background:var(--gradOrange)}
.stat.workouts::after{background:var(--gradGreen)}
.stat.progress::after{background:var(--gradRed)}
.stat.steps::after{background:linear-gradient(135deg,#f7971e 0%, #ffd200 100%)}
.stat.cardio::after{background:linear-gradient(135deg,#7f00ff 0%, #e100ff 100%)}
.statRow{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;position:relative;z-index:2}
.statName{font-weight:950;font-size:22px;letter-spacing:-.02em}
.statVal{font-weight:950;font-size:30px;letter-spacing:-.02em}
.statUnit{font-weight:900;font-size:14px;color:rgba(255,255,255,.80)}
.statSub{position:relative;z-index:2;margin-top:6px;color:rgba(255,255,255,.82);font-weight:850;font-size:13px}

.ringRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
@media (max-width:390px){.ringRow{grid-template-columns:repeat(2,minmax(0,1fr))}}
.ringCard{
  border-radius:22px;
  padding:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  display:flex;gap:10px;align-items:center;
  min-width:0;
}
.ring{
  --p:0;--col:rgba(245,158,11,.95);
  width:78px;height:78px;border-radius:999px;
  background:conic-gradient(var(--col) calc(var(--p)*1turn), rgba(255,255,255,.14) 0);
  position:relative;flex:0 0 auto;
}
.ring::after{content:"";position:absolute;inset:8px;border-radius:999px;background:rgba(15,18,48,.95);border:1px solid rgba(255,255,255,.10)}
.ringCenter{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2;font-weight:950;line-height:1.05}
.ringCenter .big{font-size:16px}
.ringCenter .tiny{font-size:11px;color:rgba(255,255,255,.70);font-weight:900;margin-top:2px}
.rLabel{font-weight:950}
.rSub{font-size:12px;color:rgba(255,255,255,.72);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.page{display:none}
.page.active{display:block}
.toolbar{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px 12px;
  border-radius:28px;
  background:var(--gradHeader);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:var(--shadow);
}
.tbTitle{font-weight:950;font-size:22px;letter-spacing:-.02em}
.tbSub{font-weight:800;color:rgba(255,255,255,.80);font-size:13px;margin-top:2px}
.tbLeft{display:flex;align-items:center;gap:10px}
.iconBtn{
  width:38px;height:38px;border-radius:14px;border:1px solid rgba(255,255,255,.20);
  background:rgba(0,0,0,.12);
  display:grid;place-items:center;cursor:pointer;color:white;
}
.pills{display:flex;gap:10px;overflow:auto;padding:10px 8px 0}
.pill{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 14px;
  border-radius:14px;
  font-weight:950;
  white-space:nowrap;
  cursor:pointer;
}
.pill.active{background:var(--gradOrange);color:#140d2e;border-color:rgba(255,255,255,.18)}
.block{padding:12px}
.panel{
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  overflow:hidden;
}
.panelHeader{
  padding:12px;
  background:linear-gradient(135deg,rgba(255,65,108,.50),rgba(255,152,25,.40));
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;justify-content:space-between;align-items:center;gap:10px;
}
.panelHeader .phTitle{font-weight:950}
.segment{display:flex;gap:10px;align-items:center;font-weight:950;color:rgba(255,255,255,.85)}
.segment .segBtn{cursor:pointer;color:rgba(255,255,255,.9)}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.10);text-align:center;font-weight:900}
.table th{font-size:12px;color:rgba(255,255,255,.70);background:rgba(255,255,255,.04)}
.table td{font-size:14px}
.table tr:last-child td{border-bottom:none}
.addRow{padding:12px;display:flex;justify-content:center}
.addBtn{
  width:100%;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:12px 14px;
  border-radius:16px;
  font-weight:950;
  cursor:pointer;
}
.timerCard{
  margin-top:12px;
  border-radius:22px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(135deg,rgba(106,17,203,.35),rgba(255,81,47,.25),rgba(240,152,25,.25));
  padding:14px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.timerVal{font-weight:950;font-size:44px;letter-spacing:-.03em}
.timerBtn{
  flex:1;
  border:none;
  border-radius:16px;
  padding:12px 14px;
  font-weight:950;
  background:var(--gradOrange);
  color:#140d2e;
  cursor:pointer;
}
.formRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{display:block;font-size:12px;color:rgba(255,255,255,.70);font-weight:850;margin:10px 0 6px}
input,textarea,select{
  width:100%;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  outline:none;
  font-size:14px;
}
textarea{min-height:110px;resize:vertical}
.list{display:flex;flex-direction:column;gap:10px}
.item{
  padding:12px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
}
.itemTitle{font-weight:950;font-size:18px}
.itemMeta{margin-top:6px;color:rgba(255,255,255,.78);font-weight:850}
.itemBody{margin-top:10px;white-space:pre-wrap;color:rgba(255,255,255,.88)}
.itemActions{display:flex;gap:10px;margin-top:12px}
.btnSm{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;border-radius:14px;font-weight:950;cursor:pointer
}
.btnSm.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.28)}
.totalBar{
  margin-top:12px;
  padding:12px;
  border-radius:22px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  font-weight:950;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
}
.coachBox{
  margin-top:12px;
  padding:12px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(135deg,rgba(255,65,108,.18),rgba(106,17,203,.16));
}
.coachTitle{font-weight:950}
.coachNote{margin-top:8px;color:rgba(255,255,255,.90);font-weight:850;font-style:italic}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
  <div class="phone">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="header">
        <div class="headerInner">
          <div class="headerTop">
            <div class="hIconBtn" id="btnMenu">‚ò∞</div>
            <div style="text-align:center;flex:1">
              <div class="hTitle">Dashboard</div>
            </div>
            <div class="hIconBtn" id="btnSettings">‚öô</div>
          </div>
          <div style="margin-top:10px">
            <div class="hSub" style="font-size:20px;font-weight:950">Welcome Back!</div>
            <div class="hSub" id="dashDate">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card sectionPad">
        <div class="grid2">
          <div class="stat weight" data-nav="weight">
            <div class="statRow">
              <div>
                <div class="statName">Weight</div>
                <div class="statVal" id="dashWeight">‚Äî <span class="statUnit">kg</span></div>
              </div>
            </div>
          </div>
          <div class="stat meals" data-nav="meals">
            <div class="statRow">
              <div>
                <div class="statName">Meals</div>
                <div class="statVal" id="dashMeals">‚Äî <span class="statUnit">Cal</span></div>
              </div>
            </div>
          </div>
          <div class="stat workouts" data-nav="workouts">
            <div class="statRow">
              <div>
                <div class="statName">Workouts</div>
                <div class="statVal"><span id="dashWorkouts">0</span> <span class="statUnit">This Week</span></div>
              </div>
            </div>
          </div>
          <div class="stat progress" data-nav="progress">
            <div class="statRow">
              <div>
                <div class="statName">Progress</div>
                <div class="statSub" id="dashProgressSub">Waist / notes</div>
              </div>
            </div>
          </div>
          <div class="stat steps" data-nav="steps">
            <div class="statRow">
              <div>
                <div class="statName">Steps</div>
                <div class="statVal"><span id="dashSteps">0</span> <span class="statUnit">Today</span></div>
              </div>
            </div>
            <div class="statSub" id="dashStepsSub">Target: ‚Äî</div>
          </div>
          <div class="stat cardio" data-nav="cardio">
            <div class="statRow">
              <div>
                <div class="statName">Cardio</div>
                <div class="statVal"><span id="dashCardio">0</span> <span class="statUnit">This month</span></div>
              </div>
            </div>
            <div class="statSub" id="dashCardioSub">‚Äî</div>
          </div>
        </div>

        <div class="ringRow">
          <div class="ringCard">
            <div class="ring" id="calRing"><div class="ringCenter"><div class="big" id="calBig">‚Äî</div><div class="tiny">kcal</div></div></div>
            <div style="min-width:0">
              <div class="rLabel">Calories</div>
              <div class="rSub" id="calSub">Set target</div>
            </div>
          </div>
          <div class="ringCard">
            <div class="ring" id="protRing"><div class="ringCenter"><div class="big" id="protBig">‚Äî</div><div class="tiny">g</div></div></div>
            <div style="min-width:0">
              <div class="rLabel">Protein</div>
              <div class="rSub" id="protSub">Set target</div>
            </div>
          </div>
          <div class="ringCard">
            <div class="ring" id="lossRing"><div class="ringCenter"><div class="big" id="lossBig">‚Äî</div><div class="tiny">kg/wk</div></div></div>
            <div style="min-width:0">
              <div class="rLabel">Weight Change</div>
              <div class="rSub" id="lossSub">Needs 7 days</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKOUTS -->
    <div id="page-workouts" class="page">
      <div class="toolbar">
        <div class="tbLeft">
          <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        </div>
        <div style="text-align:center;flex:1">
          <div class="tbTitle">Workout</div>
          <div class="tbSub" id="workoutDayLabel">‚Äî</div>
        </div>
        <div class="iconBtn" id="manageDaysBtn">üë§+</div>
      </div>

      <div id="workoutDaysView">
        <div class="card sectionPad">
          <div class="grid2" id="dayGrid"></div>
        </div>
      </div>

      <div id="workoutSessionView" class="hidden">
        <div class="pills" id="exTabs"></div>
        <div class="tbSub" style="padding:0 12px;margin-top:8px">To add/remove exercises: tap <b>Edit Day</b> (edits the workout template).</div>

        <div class="card sectionPad">
          <div class="panel">
            <div class="panelHeader">
              <div class="phTitle" id="exTitle">Bench Press</div>
              <div class="segment">
                <span class="segBtn" id="segLast">Last Session</span>
                <span style="opacity:.5">|</span>
                <span class="segBtn" id="segToday">Today's Sets</span>
              </div>
            </div>
            <div style="padding:0 10px 10px">
              <table class="table">
                <thead><tr><th>Set</th><th>Reps</th><th>Weight (kg)</th><th>Reps</th><th>Weight</th></tr></thead>
                <tbody id="setTbody"></tbody>
              </table>
            </div>
            <div class="addRow"><button class="addBtn" id="addSetBtn">+ Add Set</button></div>
          </div>

          <div class="timerCard">
            <div>
              <div class="timerVal" id="timerVal">03:00</div>
              <div class="tbSub">Rest Timer</div>
            </div>
            <button class="timerBtn" id="timerBtn">Start Timer</button>
          </div>

          <div class="formRow" style="margin-top:12px">
            <div><label>Date</label><input id="wo_date" type="date"></div>
            <div><label>Notes</label><input id="wo_notes" placeholder="energy, cues"></div>
          </div>
          <label>Coach Notes (optional)</label>
          <textarea id="wo_coach" placeholder="Advice for next time"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btnSm" id="wo_back_days">Days</button>
            <button class="btnSm" id="wo_edit_day" style="flex:1;background:rgba(255,255,255,.08)">Edit Day</button>
            <button class="btnSm" id="wo_load_prev" style="flex:1">Load Last</button>
            <button class="btnSm" id="wo_save" style="flex:1;background:var(--gradOrange);color:#140d2e;border:none">Save</button>
          </div>
          <div class="tbSub" id="wo_prev_label" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- Manage days sheet -->
      <div class="card sectionPad hidden" id="manageDaysSheet">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div style="font-weight:950;font-size:18px">Manage Workout Days</div>
          <button class="btnSm" id="closeManage">Close</button>
        </div>
        <label>Workout day</label>
        <select id="day_select"></select>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btnSm" id="day_new" style="flex:1">New</button>
          <button class="btnSm" id="day_edit" style="flex:1">Edit</button>
          <button class="btnSm danger" id="day_delete" style="flex:1">Delete</button>
        </div>
        <div class="item hidden" id="day_editor" style="margin-top:12px">
          <div style="font-weight:950">Day Editor</div>
          <div class="formRow">
            <div><label>Name</label><input id="day_name"></div>
            <div><label>Notes</label><input id="day_notes"></div>
          </div>
          <label>Scheduled weekdays</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap" id="weekdayChecks"></div>
          <label>Exercises (one per line, optional xN sets)</label>
          <textarea id="day_exercises"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btnSm" id="day_cancel" style="flex:1">Cancel</button>
            <button class="btnSm" id="day_save" style="flex:1;background:var(--gradGreen);color:#102018;border:none">Save Day</button>
          </div>
        </div>
      </div>

    </div>

    <!-- MEALS -->
    <div id="page-meals" class="page">
      <div class="toolbar">
        <div class="tbLeft">
          <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        </div>
        <div style="text-align:center;flex:1">
          <div class="tbTitle">Meals</div>
          <div class="tbSub" id="mealsDateLabel">‚Äî</div>
        </div>
        <div class="iconBtn" data-nav="mealsAdd">üç¥</div>
      </div>

      <div class="card sectionPad">
        <div id="mealSections"></div>

        <div class="totalBar" id="mealsTotalBar">Total: ‚Äî</div>

        <div class="coachBox">
          <div class="coachTitle">Coach's Notes</div>
          <div class="coachNote" id="mealsCoachPreview">Write notes below‚Ä¶</div>
          <label style="margin-top:10px">Coach notes (editable)</label>
          <textarea id="coach_meals"></textarea>
        </div>

        <div class="card" style="margin-top:12px;padding:12px;border-radius:22px;background:rgba(255,255,255,.04)">
          <div style="font-weight:950;margin-bottom:8px">Add / Edit Meal</div>
          <div class="formRow">
            <div><label>Date</label><input id="m_date" type="date"></div>
            <div><label>Title</label><input id="m_title" placeholder="Breakfast"></div>
          </div>
          <div class="formRow">
            <div><label>Calories</label><input id="m_cals" inputmode="numeric"></div>
            <div><label>Protein (g)</label><input id="m_prot" inputmode="numeric"></div>
          </div>
          <label>What you ate</label>
          <textarea id="m_details"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btnSm" id="m_cancel" style="display:none">Cancel</button>
            <button class="btnSm" id="m_save" style="flex:1;background:var(--gradOrange);color:#140d2e;border:none">Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WEIGHT -->
    <div id="page-weight" class="page">
      <div class="toolbar">
        <div class="tbLeft"><div class="iconBtn" data-back="dashboard">‚Äπ</div></div>
        <div style="text-align:center;flex:1">
          <div class="tbTitle">Weight</div>
          <div class="tbSub">Log weigh-ins</div>
        </div>
        <div class="iconBtn" data-nav="weightAdd">‚öñ</div>
      </div>

      <div class="card sectionPad">
        <div class="formRow">
          <div><label>Date</label><input id="w_date" type="date"></div>
          <div><label>Weight (kg)</label><input id="w_kg" inputmode="decimal"></div>
        </div>
        <label>Notes</label>
        <input id="w_notes" placeholder="sleep, stress, salt‚Ä¶">
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btnSm" id="w_cancel" style="display:none">Cancel</button>
          <button class="btnSm" id="w_save" style="flex:1;background:var(--gradBlue);color:#08112b;border:none">Add</button>
        </div>

        <div style="margin-top:12px" class="list" id="w_list"></div>
      </div>
    </div>

    <!-- PROGRESS -->
    <div id="page-progress" class="page">
      <div class="toolbar">
        <div class="tbLeft"><div class="iconBtn" data-back="dashboard">‚Äπ</div></div>
        <div style="text-align:center;flex:1">
          <div class="tbTitle">Progress</div>
          <div class="tbSub">Waist + notes</div>
        </div>
        <div class="iconBtn">üìà</div>
      </div>

      <div class="card sectionPad">
        <div class="formRow">
          <div><label>Date</label><input id="p_date" type="date"></div>
          <div><label>Waist (cm)</label><input id="p_waist" inputmode="numeric"></div>
        </div>
        <label>Photos (optional)</label>
        <input id="p_photos">
        <label>Notes</label>
        <textarea id="p_notes"></textarea>
        <div class="coachBox">
          <div class="coachTitle">Suggested Improvements</div>
          <label style="margin-top:10px">Coach notes (editable)</label>
          <textarea id="coach_progress"></textarea>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btnSm" id="p_cancel" style="display:none">Cancel</button>
          <button class="btnSm" id="p_save" style="flex:1;background:var(--gradRed);color:#140d2e;border:none">Add</button>
        </div>

        <div style="margin-top:12px" class="list" id="p_list"></div>
      </div>
    </div>

    
    <!-- STEPS -->
    <div id="page-steps" class="page">
      <div class="toolbar">
        <div class="tbLeft"><div class="iconBtn" data-back="dashboard">‚Äπ</div></div>
        <div style="text-align:center;flex:1">
          <div class="tbTitle">Steps</div>
          <div class="tbSub">Manual daily log</div>
        </div>
        <div class="iconBtn">üëü</div>
      </div>

      <div class="card sectionPad">
        <div class="totalBar" id="stepsTotalBar">Today: ‚Äî</div>

        <div class="formRow" style="margin-top:10px">
          <div><label>Date</label><input id="s_date" type="date"></div>
          <div><label>Steps</label><input id="s_steps" inputmode="numeric" placeholder="8000"></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btnSm" id="s_cancel" style="display:none">Cancel</button>
          <button class="btnSm" id="s_save" style="flex:1;background:linear-gradient(135deg,#f7971e 0%, #ffd200 100%);color:#140d2e;border:none">Add</button>
        </div>

        <div style="margin-top:12px" class="list" id="s_list"></div>
        <div class="small" style="margin-top:10px;opacity:.8">
          Tip: enter your steps once per day (edit if you re-check later).
        </div>
      </div>
    </div>


    <!-- CARDIO -->
    <div id="page-cardio" class="page">
      <div class="toolbar">
        <div class="tbLeft"><div class="iconBtn" data-back="dashboard">‚Äπ</div></div>
        <div style="text-align:center;flex:1">
          <div class="tbTitle">Cardio</div>
          <div class="tbSub">Runs / cardio sessions</div>
        </div>
        <div class="iconBtn">üèÉ</div>
      </div>

      <div class="card sectionPad">
        <div class="totalBar" id="c_totalBar">This month: ‚Äî</div>

        <div class="formRow" style="margin-top:10px">
          <div><label>Date</label><input id="c_date" type="date"></div>
          <div><label>Type</label>
            <select id="c_type">
              <option value="Run">Run</option>
              <option value="Treadmill">Treadmill</option>
              <option value="Bike">Bike</option>
              <option value="Row">Row</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="formRow" style="margin-top:10px">
          <div><label>Distance (km)</label><input id="c_km" inputmode="decimal" placeholder="5"></div>
          <div><label>Time (mm:ss)</label><input id="c_time" placeholder="25:30"></div>
        </div>

        <label>Notes</label>
        <textarea id="c_notes" placeholder="Easy pace, intervals, HR, route‚Ä¶"></textarea>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btnSm" id="c_cancel" style="display:none">Cancel</button>
          <button class="btnSm" id="c_save" style="flex:1;background:linear-gradient(135deg,#7f00ff 0%, #e100ff 100%);color:#fff;border:none">Add</button>
        </div>

        <div style="margin-top:12px" class="list" id="c_list"></div>
      </div>
    </div>

<!-- SETTINGS (simple modal) -->
    <div class="card sectionPad hidden" id="settingsModal">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div style="font-weight:950;font-size:18px">Settings</div>
        <button class="btnSm" id="closeSettings">Close</button>
      </div>
      <label>Calories/day</label><input id="t_cal" inputmode="numeric">
      <label>Protein/day (g)</label><input id="t_pro" inputmode="numeric">
      <label>Steps/day target</label><input id="t_steps" inputmode="numeric" placeholder="8000">
      <div class="formRow">
        <div><label>Age</label><input id="age" inputmode="numeric"></div>
        <div><label>Sex</label><select id="sex"><option value="male">Male</option><option value="female">Female</option></select></div>
      </div>
      <div class="formRow">
        <div><label>Height (cm)</label><input id="heightCm" inputmode="numeric"></div>
        <div><label>Weight (kg)</label><input id="weightKg" inputmode="decimal"></div>
      </div>
      <label>Gym days/week</label><input id="gymDays" inputmode="numeric">
      <label>Goal text</label><input id="goal">
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btnSm" id="saveSettings" style="flex:1;background:var(--gradOrange);color:#140d2e;border:none">Save</button>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  const APP_KEY="fitness_log_vibrant_v2_3";
  const todayISO=()=>new Date().toISOString().slice(0,10);
  const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
  const $=(id)=>document.getElementById(id);
  const parseISO=(d)=>new Date(d+"T00:00:00");
  const isSameMonth=(d,ref)=>{const a=parseISO(d),b=parseISO(ref);return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth();};
  const safeParse=(raw)=>{try{return JSON.parse(raw)}catch{return null}};

  const defaultStore=()=>({
    profile:{age:30,sex:"male",heightCm:178,weightKg:84.5,gymDays:4,goal:"75kg with visible six-pack, then lean gain"},
    targets:{calories:2200,proteinG:170,steps:8000},
    weights:[], meals:[], progress:[], steps:[], cardio:[],
    coach:{meals:"",workouts:"",progress:""},
    workoutDays:[
      {id:"push",name:"Push",notes:"",scheduled:[1,4],exercises:[{name:"Bench Press",defaultSets:3},{name:"Overhead Press",defaultSets:3},{name:"Tricep Extensions",defaultSets:3}]},
      {id:"pull",name:"Pull",notes:"",scheduled:[2,5],exercises:[{name:"Lat Pulldown",defaultSets:3},{name:"Row",defaultSets:3},{name:"Biceps Curl",defaultSets:3}]},
      {id:"legs",name:"Legs",notes:"",scheduled:[3,6],exercises:[{name:"Squat",defaultSets:3},{name:"RDL",defaultSets:3},{name:"Leg Press",defaultSets:3}]}
    ],
    workouts:[]
  });

  let store = safeParse(localStorage.getItem(APP_KEY)) || defaultStore();
  const save=()=>localStorage.setItem(APP_KEY, JSON.stringify(store));

  // --- Navigation ---
  const pages = {
    dashboard: $("page-dashboard"),
    workouts: $("page-workouts"),
    meals: $("page-meals"),
    weight: $("page-weight"),
    progress: $("page-progress"),
    steps: $("page-steps"),
    cardio: $("page-cardio"),
  };

  function setPage(name){
    Object.entries(pages).forEach(([k,el])=>el.classList.toggle("active", k===name));
    // Hide overlays on nav
    $("settingsModal").classList.add("hidden");
    $("manageDaysSheet").classList.add("hidden");
    if(name==="dashboard") renderDashboard();
    if(name==="meals") renderMealsPage();
    if(name==="weight") renderWeightPage();
    if(name==="progress") renderProgressPage();
    if(name==="steps") renderStepsPage();
    if(name==="cardio") renderCardioPage();
    if(name==="workouts"){ renderWorkoutDays(); showWorkoutDaysView(); }
  }

  document.querySelectorAll("[data-nav]").forEach(el=>{
    el.addEventListener("click", ()=> {
      const nav = el.getAttribute("data-nav");
      if(nav && pages[nav]) setPage(nav);
    });
  });
  document.querySelectorAll("[data-back]").forEach(el=>{
    el.addEventListener("click", ()=> setPage(el.getAttribute("data-back")));
  });

  // --- Settings ---
  function fillSettings(){
    $("t_cal").value=store.targets.calories||"";
    $("t_pro").value=store.targets.proteinG||"";
    $("t_steps").value=store.targets.steps||"";
    $("age").value=store.profile.age||"";
    $("sex").value=store.profile.sex||"male";
    $("heightCm").value=store.profile.heightCm||"";
    $("weightKg").value=store.profile.weightKg||"";
    $("gymDays").value=store.profile.gymDays||"";
    $("goal").value=store.profile.goal||"";
  }
  function openSettings(){
    fillSettings();
    $("settingsModal").classList.remove("hidden");
    window.scrollTo(0,0);
  }
  $("btnSettings").addEventListener("click", openSettings);
  $("closeSettings").addEventListener("click", ()=> $("settingsModal").classList.add("hidden"));
  $("saveSettings").addEventListener("click", ()=>{
    const c=Number($("t_cal").value), p=Number($("t_pro").value), s=Number($("t_steps").value);
    if(Number.isFinite(c)&&c>0) store.targets.calories=c;
    if(Number.isFinite(p)&&p>0) store.targets.proteinG=p;
    if(Number.isFinite(s)&&s>0) store.targets.steps=s;
    store.profile.age=Number($("age").value)||store.profile.age;
    store.profile.sex=$("sex").value||store.profile.sex;
    store.profile.heightCm=Number($("heightCm").value)||store.profile.heightCm;
    store.profile.weightKg=Number($("weightKg").value)||store.profile.weightKg;
    store.profile.gymDays=Math.max(0, Math.min(7, Number($("gymDays").value)||store.profile.gymDays));
    store.profile.goal=$("goal").value.trim()||store.profile.goal;
    save();
    $("settingsModal").classList.add("hidden");
    renderDashboard();
    alert("Saved!");
  });

  // --- Dashboard date label ---
  const fmtDate = (d) => {
    const dt = new Date(d+"T00:00:00");
    return dt.toLocaleDateString(undefined, { weekday:"long", month:"long", day:"numeric" });
  };
  $("dashDate").textContent = fmtDate(todayISO());

  // --- Rings + widgets ---
  function ringSet(el, p, col){
    el.style.setProperty("--p", String(Math.max(0,Math.min(1,p))));
    el.style.setProperty("--col", col);
  }
  function mslBmrKgCm(age, sex, heightCm, weightKg){
    const s = sex==="male" ? 5 : -161;
    return 10*weightKg + 6.25*heightCm - 5*age + s;
  }
  function activityFactor(gymDays){
    if(gymDays<=1) return 1.35;
    if(gymDays==2) return 1.45;
    if(gymDays==3) return 1.55;
    if(gymDays==4) return 1.60;
    if(gymDays==5) return 1.70;
    return 1.75;
  }
  function workoutsThisWeek(){
    const now = new Date();
    const day = now.getDay(); // 0 Sun
    const diff = (day+6)%7; // Monday start
    const monday = new Date(now);
    monday.setDate(now.getDate()-diff);
    monday.setHours(0,0,0,0);
    return store.workouts.filter(w=>{
      const dt = new Date(w.date+"T00:00:00");
      return dt >= monday;
    }).length;
  }

  function renderDashboard(){
    // Weight tile
    const lastW = [...store.weights].sort((a,b)=>a.date<b.date?1:-1)[0];
    $("dashWeight").textContent = lastW ? Number(lastW.weightKg).toFixed(1) : "‚Äî";

    // Meals tile
    const t = todayISO();
    const todays = store.meals.filter(m=>m.date===t);
    const cals = todays.reduce((s,m)=>s+(Number(m.calories)||0),0);
    $("dashMeals").textContent = cals ? String(cals).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";

    // Workouts tile
    $("dashWorkouts").textContent = String(workoutsThisWeek());


    // Steps tile
    const stepTarget = Number(store.targets?.steps||0);
    const today = todayISO();
    const todayEntry = (store.steps||[]).find(s=>s.date===today);
    const todaySteps = todayEntry ? Number(todayEntry.steps)||0 : 0;
    if(document.getElementById("dashSteps")){
      document.getElementById("dashSteps").textContent = String(todaySteps);
      document.getElementById("dashStepsSub").textContent = stepTarget ? `Target: ${stepTarget}` : "Set target in Settings";
    }


    // Cardio tile (this month)
    const monthCardio = (store.cardio||[]).filter(c=>c.date && isSameMonth(c.date, today));
    const monthCount = monthCardio.length;
    const monthKm = monthCardio.reduce((s,x)=>s+(Number(x.km)||0),0);
    if(document.getElementById("dashCardio")){
      document.getElementById("dashCardio").textContent = String(monthCount);
      document.getElementById("dashCardioSub").textContent = monthCount ? `${monthKm.toFixed(1)} km this month` : "No cardio logged";
    }


    // Rings
    const tC=Number(store.targets?.calories||0), tP=Number(store.targets?.proteinG||0);
    const prot = todays.reduce((s,m)=>s+(Number(m.proteinG)||0),0);

    if(tC>0){
      const ratio=cals/tC;
      let col="rgba(245,158,11,.95)";
      if(ratio>=0.85 && ratio<=1.10) col="rgba(34,197,94,.95)";
      if(ratio>1.10) col="rgba(239,68,68,.95)";
      ringSet($("calRing"), Math.min(1,ratio), col);
      $("calBig").textContent = `${cals}/${tC}`;
      $("calSub").textContent = ratio<=1.10 ? "On track" : "Over target";
    } else {
      ringSet($("calRing"), 0, "rgba(245,158,11,.95)");
      $("calBig").textContent = "‚Äî";
      $("calSub").textContent = "Set target";
    }

    if(tP>0){
      const ratio=prot/tP;
      let col="rgba(239,68,68,.95)";
      if(ratio>=0.70 && ratio<1.0) col="rgba(245,158,11,.95)";
      if(ratio>=1.0) col="rgba(34,197,94,.95)";
      ringSet($("protRing"), Math.min(1,ratio), col);
      $("protBig").textContent = `${prot}/${tP}`;
      $("protSub").textContent = ratio>=1 ? "Target hit" : "Keep going";
    } else {
      ringSet($("protRing"), 0, "rgba(239,68,68,.95)");
      $("protBig").textContent = "‚Äî";
      $("protSub").textContent = "Set target";
    }

    // Expected change using last 7 day avg cals
    const byDate=new Map();
    store.meals.forEach(m=>{
      if(!m.date) return;
      const cur=byDate.get(m.date)||{cals:0,has:false};
      if(m.calories!=null && m.calories!==""){cur.cals+=Number(m.calories); cur.has=true;}
      byDate.set(m.date,cur);
    });
    const dates=[...byDate.keys()].sort();
    const last7 = dates.filter(d=>byDate.get(d).has).slice(-7);
    if(last7.length>=7){
      const avgCals = Math.round(last7.reduce((s,d)=>s+byDate.get(d).cals,0)/7);
      const p = store.profile;
      const baseW = lastW ? Number(lastW.weightKg) : Number(p.weightKg)||84.5;
      const bmr = mslBmrKgCm(Number(p.age)||30, p.sex||"male", Number(p.heightCm)||178, baseW);
      const tdee = Math.round(bmr * activityFactor(Number(p.gymDays)||4));
      const deficitPerDay = tdee - avgCals;
      const kgPerWeek = (deficitPerDay*7) / 7700;
      const abs = Math.max(0, Math.min(1, Math.abs(kgPerWeek)/1.0));
      let col="rgba(245,158,11,.95)";
      if(kgPerWeek < 0) col="rgba(239,68,68,.95)";
      else if(kgPerWeek >= 0.25 && kgPerWeek <= 0.75) col="rgba(34,197,94,.95)";
      else if(kgPerWeek > 0.75) col="rgba(239,68,68,.95)";
      ringSet($("lossRing"), abs, col);
      $("lossBig").textContent = `${(Math.round(kgPerWeek*10)/10).toFixed(1)}`;
      $("lossSub").textContent = "kg / week";
    } else {
      ringSet($("lossRing"), 0, "rgba(255,255,255,.20)");
      $("lossBig").textContent = "‚Äî";
      $("lossSub").textContent = "Needs 7 days";
    }
  }

  // --- Weight page ---
  let w_edit=null;
  function renderWeightPage(){
    $("w_date").value=todayISO();
    $("w_list").innerHTML="";
    const sorted=[...store.weights].sort((a,b)=>a.date<b.date?1:-1);
    sorted.forEach(e=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="itemTitle">${Number(e.weightKg).toFixed(1)} kg</div>
                       <div class="itemMeta">${e.date}</div>
                       ${e.notes?`<div class="itemBody">${e.notes}</div>`:""}`;
      const acts=document.createElement("div"); acts.className="itemActions";
      const b1=document.createElement("button"); b1.className="btnSm"; b1.textContent="Edit";
      b1.onclick=()=>{w_edit=e.id; $("w_date").value=e.date; $("w_kg").value=e.weightKg; $("w_notes").value=e.notes||""; $("w_cancel").style.display="inline-block"; $("w_save").textContent="Save";};
      const b2=document.createElement("button"); b2.className="btnSm danger"; b2.textContent="Delete";
      b2.onclick=()=>{store.weights=store.weights.filter(x=>x.id!==e.id); save(); renderWeightPage(); renderDashboard();};
      acts.append(b1,b2);
      div.append(acts);
      $("w_list").append(div);
    });
    if(!sorted.length){
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="itemTitle">No weigh-ins yet</div><div class="itemMeta">Add one above</div>`;
      $("w_list").append(div);
    }
  }
  $("w_cancel").addEventListener("click", ()=>{
    w_edit=null; $("w_date").value=todayISO(); $("w_kg").value=""; $("w_notes").value=""; $("w_cancel").style.display="none"; $("w_save").textContent="Add";
  });
  $("w_save").addEventListener("click", ()=>{
    const date=$("w_date").value||todayISO();
    const kg=Number($("w_kg").value);
    if(!Number.isFinite(kg)||kg<=0){alert("Enter a valid weight");return;}
    const notes=$("w_notes").value.trim();
    if(w_edit) store.weights=store.weights.map(x=>x.id===w_edit?({...x,date,weightKg:kg,notes:notes||undefined}):x);
    else store.weights.unshift({id:uid(),date,weightKg:kg,notes:notes||undefined});
    store.profile.weightKg=kg;
    save();
    $("w_cancel").click();
    renderWeightPage(); renderDashboard();
  });

  // --- Meals page ---
  let m_edit=null;
  function renderMealsPage(){
    $("mealsDateLabel").textContent = fmtDate(todayISO());
    $("m_date").value = todayISO();
    $("coach_meals").value = store.coach.meals || "";
    $("mealsCoachPreview").textContent = store.coach.meals ? store.coach.meals.split("\n")[0] : "Write notes below‚Ä¶";

    const t=todayISO();
    const todays=store.meals.filter(m=>m.date===t);
    const totalC=todays.reduce((s,m)=>s+(Number(m.calories)||0),0);
    const totalP=todays.reduce((s,m)=>s+(Number(m.proteinG)||0),0);
    $("mealsTotalBar").textContent = `Total: ${totalC} Cal / ${totalP}g Protein`;

    // Group by simple title keywords (Breakfast/Lunch/Dinner) else Other
    const buckets = {Breakfast:[], Lunch:[], Dinner:[], Other:[]};
    todays.forEach(m=>{
      const key = (m.title||"").toLowerCase().includes("breakfast") ? "Breakfast"
               : (m.title||"").toLowerCase().includes("lunch") ? "Lunch"
               : (m.title||"").toLowerCase().includes("dinner") ? "Dinner"
               : "Other";
      buckets[key].push(m);
    });

    const container=$("mealSections");
    container.innerHTML="";
    Object.entries(buckets).forEach(([name,items])=>{
      if(items.length===0) return;
      const sec=document.createElement("div");
      sec.style.marginBottom="12px";
      const title=document.createElement("div");
      title.style.fontWeight="950";
      title.style.fontSize="18px";
      title.style.margin="8px 0";
      title.textContent=name;
      sec.append(title);

      items.forEach(e=>{
        const div=document.createElement("div");
        div.className="item";
        const meta = `${e.calories||0} Cal / ${e.proteinG||0}g Protein`;
        div.innerHTML = `<div class="itemTitle">${meta}</div>
                         ${e.details?`<div class="itemBody">${e.details}</div>`:""}`;
        const acts=document.createElement("div"); acts.className="itemActions";
        const b1=document.createElement("button"); b1.className="btnSm"; b1.textContent="Edit";
        b1.onclick=()=>{m_edit=e.id; $("m_date").value=e.date; $("m_title").value=e.title; $("m_cals").value=e.calories??""; $("m_prot").value=e.proteinG??""; $("m_details").value=e.details||""; $("m_cancel").style.display="inline-block"; $("m_save").textContent="Save";};
        const b2=document.createElement("button"); b2.className="btnSm danger"; b2.textContent="Delete";
        b2.onclick=()=>{store.meals=store.meals.filter(x=>x.id!==e.id); save(); renderMealsPage(); renderDashboard();};
        acts.append(b1,b2);
        div.append(acts);
        sec.append(div);
      });
      container.append(sec);
    });

    if(!todays.length){
      const empty=document.createElement("div");
      empty.className="item";
      empty.innerHTML = `<div class="itemTitle">No meals logged today</div><div class="itemMeta">Add one below</div>`;
      container.append(empty);
    }
  }
  $("coach_meals").addEventListener("input", ()=>{
    store.coach.meals = $("coach_meals").value;
    save();
    $("mealsCoachPreview").textContent = store.coach.meals ? store.coach.meals.split("\n")[0] : "Write notes below‚Ä¶";
  });
  $("m_cancel").addEventListener("click", ()=>{
    m_edit=null; $("m_date").value=todayISO(); $("m_title").value=""; $("m_cals").value=""; $("m_prot").value=""; $("m_details").value="";
    $("m_cancel").style.display="none"; $("m_save").textContent="Add";
  });
  $("m_save").addEventListener("click", ()=>{
    const date=$("m_date").value||todayISO();
    const title=$("m_title").value.trim();
    if(!title){alert("Title required");return;}
    const calories=$("m_cals").value.trim()===""?undefined:Number($("m_cals").value);
    const proteinG=$("m_prot").value.trim()===""?undefined:Number($("m_prot").value);
    const payload={date,title,calories:Number.isFinite(calories)?calories:undefined,proteinG:Number.isFinite(proteinG)?proteinG:undefined,details:$("m_details").value.trim()||undefined};
    if(m_edit) store.meals=store.meals.map(x=>x.id===m_edit?({...x,...payload}):x);
    else store.meals.unshift({id:uid(),...payload});
    save();
    $("m_cancel").click();
    renderMealsPage(); renderDashboard();
  });

  // --- Progress page ---
  let p_edit=null;
  function renderProgressPage(){
    $("p_date").value=todayISO();
    $("coach_progress").value = store.coach.progress || "";
    const list=$("p_list");
    list.innerHTML="";
    const sorted=[...store.progress].sort((a,b)=>a.date<b.date?1:-1);
    sorted.forEach(e=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="itemTitle">${e.date}${e.waistCm!=null?` ‚Ä¢ Waist ${e.waistCm}cm`:""}</div>
                       ${e.notes?`<div class="itemBody">${e.notes}</div>`:""}`;
      const acts=document.createElement("div"); acts.className="itemActions";
      const b1=document.createElement("button"); b1.className="btnSm"; b1.textContent="Edit";
      b1.onclick=()=>{p_edit=e.id; $("p_date").value=e.date; $("p_waist").value=e.waistCm??""; $("p_photos").value=e.photos??""; $("p_notes").value=e.notes??""; $("p_cancel").style.display="inline-block"; $("p_save").textContent="Save";};
      const b2=document.createElement("button"); b2.className="btnSm danger"; b2.textContent="Delete";
      b2.onclick=()=>{store.progress=store.progress.filter(x=>x.id!==e.id); save(); renderProgressPage();};
      acts.append(b1,b2); div.append(acts); list.append(div);
    });
    if(!sorted.length){
      const empty=document.createElement("div");
      empty.className="item";
      empty.innerHTML = `<div class="itemTitle">No progress entries</div><div class="itemMeta">Add one above</div>`;
      list.append(empty);
    }
  }
  $("coach_progress").addEventListener("input", ()=>{store.coach.progress=$("coach_progress").value; save();});
  $("p_cancel").addEventListener("click", ()=>{
    p_edit=null; $("p_date").value=todayISO(); $("p_waist").value=""; $("p_photos").value=""; $("p_notes").value="";
    $("p_cancel").style.display="none"; $("p_save").textContent="Add";
  });
  $("p_save").addEventListener("click", ()=>{
    const date=$("p_date").value||todayISO();
    const waist=$("p_waist").value.trim()===""?undefined:Number($("p_waist").value);
    const payload={date,waistCm:Number.isFinite(waist)?waist:undefined,photos:$("p_photos").value.trim()||undefined,notes:$("p_notes").value.trim()||undefined};
    if(p_edit) store.progress=store.progress.map(x=>x.id===p_edit?({...x,...payload}):x);
    else store.progress.unshift({id:uid(),...payload});
    save();
    $("p_cancel").click();
    renderProgressPage();
  });


  // --- Steps page ---
  let s_edit=null;
  function renderStepsPage(){
    $("s_date").value=todayISO();
    const t=todayISO();
    const target=Number(store.targets?.steps||0);
    const todayEntry=(store.steps||[]).find(x=>x.date===t);
    const todaySteps=todayEntry?Number(todayEntry.steps)||0:0;
    $("stepsTotalBar").textContent = target ? `Today: ${todaySteps} / ${target} steps` : `Today: ${todaySteps} steps (set target in Settings)`;

    const list=$("s_list");
    list.innerHTML="";
    const sorted=[...(store.steps||[])].sort((a,b)=>a.date<b.date?1:-1);
    sorted.forEach(e=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="itemTitle">${e.steps} steps</div><div class="itemMeta">${e.date}</div>`;
      const acts=document.createElement("div"); acts.className="itemActions";
      const b1=document.createElement("button"); b1.className="btnSm"; b1.textContent="Edit";
      b1.onclick=()=>{s_edit=e.id; $("s_date").value=e.date; $("s_steps").value=e.steps; $("s_cancel").style.display="inline-block"; $("s_save").textContent="Save";};
      const b2=document.createElement("button"); b2.className="btnSm danger"; b2.textContent="Delete";
      b2.onclick=()=>{store.steps=store.steps.filter(x=>x.id!==e.id); save(); renderStepsPage(); renderDashboard();};
      acts.append(b1,b2); div.append(acts); list.append(div);
    });
    if(!sorted.length){
      const empty=document.createElement("div");
      empty.className="item";
      empty.innerHTML = `<div class="itemTitle">No steps logged yet</div><div class="itemMeta">Add your steps above</div>`;
      list.append(empty);
    }
  }
  $("s_cancel").addEventListener("click", ()=>{
    s_edit=null; $("s_date").value=todayISO(); $("s_steps").value=""; $("s_cancel").style.display="none"; $("s_save").textContent="Add";
  });
  $("s_save").addEventListener("click", ()=>{
    const date=$("s_date").value||todayISO();
    const steps=Number($("s_steps").value);
    if(!Number.isFinite(steps) || steps<0){alert("Enter a valid step count");return;}
    const payload={date,steps:Math.round(steps)};
    if(s_edit) store.steps=store.steps.map(x=>x.id===s_edit?({...x,...payload}):x);
    else store.steps.unshift({id:uid(),...payload});
    save();
    $("s_cancel").click();
    renderStepsPage();
  renderCardioPage(); renderDashboard();
  });


  // --- Cardio page ---
  let c_edit=null;
  function parseTimeToSec(s){
    const t=String(s||"").trim();
    if(!t) return null;
    const parts=t.split(":").map(x=>x.trim());
    if(parts.length===1){
      const m=Number(parts[0]); return Number.isFinite(m)?Math.round(m*60):null;
    }
    if(parts.length===2){
      const m=Number(parts[0]), sec=Number(parts[1]);
      if(!Number.isFinite(m)||!Number.isFinite(sec)) return null;
      return Math.round(m*60+sec);
    }
    return null;
  }
  function fmtPace(secPerKm){
    if(!Number.isFinite(secPerKm) || secPerKm<=0) return "‚Äî";
    const m=Math.floor(secPerKm/60);
    const s=Math.round(secPerKm%60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}/km`;
  }
  function renderCardioPage(){
    $("c_date").value=todayISO();
    const ref=todayISO();
    const month = (store.cardio||[]).filter(c=>c.date && isSameMonth(c.date, ref));
    const km = month.reduce((s,x)=>s+(Number(x.km)||0),0);
    $("c_totalBar").textContent = month.length ? `This month: ${month.length} sessions ‚Ä¢ ${km.toFixed(1)} km` : "This month: 0 sessions";

    const list=$("c_list");
    list.innerHTML="";
    const sorted=[...(store.cardio||[])].sort((a,b)=>a.date<b.date?1:-1);
    sorted.forEach(e=>{
      const km=Number(e.km)||0;
      const sec=Number(e.sec)||0;
      const pace = (km>0 && sec>0) ? fmtPace(sec/km) : "‚Äî";
      const timeStr = e.timeStr || (sec?`${Math.floor(sec/60)}:${String(sec%60).padStart(2,"0")}`:"‚Äî");
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="itemTitle">${e.type || "Cardio"} ‚Ä¢ ${km?km.toFixed(2):"‚Äî"} km</div>
                       <div class="itemMeta">${e.date} ‚Ä¢ ${timeStr} ‚Ä¢ Pace ${pace}</div>
                       ${e.notes?`<div class="itemBody">${e.notes}</div>`:""}`;
      const acts=document.createElement("div"); acts.className="itemActions";
      const b1=document.createElement("button"); b1.className="btnSm"; b1.textContent="Edit";
      b1.onclick=()=>{c_edit=e.id; $("c_date").value=e.date; $("c_type").value=e.type||"Run"; $("c_km").value=e.km??""; $("c_time").value=e.timeStr??""; $("c_notes").value=e.notes||""; $("c_cancel").style.display="inline-block"; $("c_save").textContent="Save";};
      const b2=document.createElement("button"); b2.className="btnSm danger"; b2.textContent="Delete";
      b2.onclick=()=>{store.cardio=store.cardio.filter(x=>x.id!==e.id); save(); renderCardioPage(); renderDashboard();};
      acts.append(b1,b2); div.append(acts); list.append(div);
    });
    if(!sorted.length){
      const empty=document.createElement("div");
      empty.className="item";
      empty.innerHTML = `<div class="itemTitle">No cardio yet</div><div class="itemMeta">Add a run/session above</div>`;
      list.append(empty);
    }
  }
  $("c_cancel").addEventListener("click", ()=>{
    c_edit=null; $("c_date").value=todayISO(); $("c_type").value="Run"; $("c_km").value=""; $("c_time").value=""; $("c_notes").value="";
    $("c_cancel").style.display="none"; $("c_save").textContent="Add";
  });
  $("c_save").addEventListener("click", ()=>{
    const date=$("c_date").value||todayISO();
    const type=$("c_type").value||"Run";
    const km = $("c_km").value.trim()===""?undefined:Number($("c_km").value);
    if(km!=null && (!Number.isFinite(km) || km<=0)){alert("Enter a valid distance");return;}
    const timeStr=$("c_time").value.trim();
    const sec=parseTimeToSec(timeStr);
    if(timeStr && sec==null){alert("Time should be like 25:30");return;}
    const notes=$("c_notes").value.trim();
    const payload={date,type,km:Number.isFinite(km)?km:undefined,timeStr:timeStr||undefined,sec:Number.isFinite(sec)?sec:undefined,notes:notes||undefined};
    if(c_edit) store.cardio=store.cardio.map(x=>x.id===c_edit?({...x,...payload}):x);
    else store.cardio.unshift({id:uid(),...payload});
    save();
    $("c_cancel").click();
    renderCardioPage(); renderDashboard();
  });

  // --- Workouts page ---
  const dayGrid=$("dayGrid");
  const workoutDaysView=$("workoutDaysView");
  const workoutSessionView=$("workoutSessionView");

  let activeDayId=null;
  let activeExName=null;
  let currentSession=null;
  let prevSession=null;

  function weekdayToday(){return new Date().getDay();}
  function isScheduledToday(day){return (day.scheduled||[]).includes(weekdayToday());}
  function findDay(id){return (store.workoutDays||[]).find(d=>d.id===id)||null;}
  function lastWorkoutForTemplate(templateId){return [...store.workouts].filter(w=>w.templateId===templateId).sort((a,b)=>a.date<b.date?1:-1)[0]||null;}
  function blankSessionFromDay(day){return {templateId:day.id,date:todayISO(),notes:"",exercises:(day.exercises||[]).map(ex=>({name:ex.name,sets:Array.from({length:ex.defaultSets||3},()=>({reps:"",kg:""}))}))};}
  function normalizePrevWorkout(day,w){
    if(!w) return null;
    const map=new Map((w.exercises||[]).map(ex=>[ex.name,ex]));
    return {date:w.date, exercises:(day.exercises||[]).map(ex=>{
      const prev=map.get(ex.name);
      return {name:ex.name, sets:(prev?.sets||[]).map(s=>({reps:s.reps??"",kg:s.kg??""}))};
    })};
  }
  function showWorkoutDaysView(){
    workoutDaysView.classList.remove("hidden");
    workoutSessionView.classList.add("hidden");
    $("manageDaysSheet").classList.add("hidden");
    $("workoutDayLabel").textContent = fmtDate(todayISO());
  }
  function showWorkoutSessionView(){
    workoutDaysView.classList.add("hidden");
    workoutSessionView.classList.remove("hidden");
  }

  function renderWorkoutDays(){
    dayGrid.innerHTML="";
    const days=store.workoutDays||[];
    days.forEach(day=>{
      const tile=document.createElement("div");
      tile.className="stat workouts";
      tile.style.minHeight="92px";
      tile.style.padding="14px";
      tile.style.cursor="pointer";
      tile.innerHTML = `<div class="statRow"><div><div class="statName">${day.name}</div><div class="statSub">${day.exercises?.length||0} exercises</div></div></div>`;
      if(isScheduledToday(day)){
        tile.style.outline="3px solid rgba(34,197,94,.55)";
        tile.style.outlineOffset="2px";
      }
      tile.addEventListener("click", ()=> openWorkoutDay(day.id));
      dayGrid.append(tile);
    });
  }

  function getCurrentExerciseObj(name){return (currentSession.exercises||[]).find(ex=>ex.name===name)||null;}
  function getPrevExerciseObj(name){return (prevSession?.exercises||[]).find(ex=>ex.name===name)||null;}

  function updateTabs(day){
    const tabs=$("exTabs");
    tabs.innerHTML="";
    (day.exercises||[]).forEach(ex=>{
      const b=document.createElement("div");
      b.className="pill"+(ex.name===activeExName?" active":"");
      b.textContent=ex.name;
      b.onclick=()=>{activeExName=ex.name; updateTabs(day); renderSetTable(); $("exTitle").textContent=activeExName;};
      tabs.append(b);
    });
  }

  function renderSetTable(){
    const tbody=$("setTbody");
    tbody.innerHTML="";
    const cur=getCurrentExerciseObj(activeExName);
    if(!cur) return;
    const prev=getPrevExerciseObj(activeExName);
    const prevSets=prev?.sets||[];
    const rows=Math.max(cur.sets.length, prevSets.length, 1);
    while(cur.sets.length<rows) cur.sets.push({reps:"",kg:""});
    for(let i=0;i<rows;i++){
      const tr=document.createElement("tr");
      const lastR=prevSets[i]?.reps??"";
      const lastK=prevSets[i]?.kg??"";
      tr.innerHTML = `<td>${i+1}</td>
        <td>${lastR}</td><td>${lastK}</td>
        <td><input data-i="${i}" data-f="reps" value="${cur.sets[i].reps??""}" style="width:56px;padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:white;text-align:center"></td>
        <td><input data-i="${i}" data-f="kg" value="${cur.sets[i].kg??""}" style="width:64px;padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:white;text-align:center"></td>`;
      tbody.append(tr);
    }
    tbody.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const i=Number(inp.getAttribute("data-i"));
        const f=inp.getAttribute("data-f");
        const cur=getCurrentExerciseObj(activeExName);
        if(!cur) return;
        cur.sets[i][f]=inp.value;
      });
    });
  }

  function openWorkoutDay(dayId){
    const day=findDay(dayId);
    if(!day) return;
    activeDayId=dayId;
    $("workoutDayLabel").textContent = fmtDate(todayISO());
    $("wo_date").value=todayISO();
    $("wo_notes").value="";
    $("wo_coach").value = store.coach.workouts || "";

    const prev=lastWorkoutForTemplate(dayId);
    prevSession = prev ? normalizePrevWorkout(day, prev) : null;
    $("wo_prev_label").textContent = prev ? `Last: ${prev.date}` : "No previous session";

    currentSession = blankSessionFromDay(day);
    activeExName = day.exercises?.[0]?.name || null;
    updateTabs(day);
    $("exTitle").textContent = activeExName || "Exercise";
    renderSetTable();
    showWorkoutSessionView();
  }

  $("addSetBtn").addEventListener("click", ()=>{
    const cur=getCurrentExerciseObj(activeExName);
    if(!cur) return;
    cur.sets.push({reps:"",kg:""});
    renderSetTable();
  });

  $("wo_back_days").addEventListener("click", ()=>{
    store.coach.workouts = $("wo_coach").value;
    save();
    showWorkoutDaysView();
    renderWorkoutDays();
  });

  $("wo_load_prev").addEventListener("click", ()=>{
    const day=findDay(activeDayId);
    if(!day) return;
    const prev=lastWorkoutForTemplate(activeDayId);
    if(!prev){alert("No previous workout");return;}
    prevSession = normalizePrevWorkout(day, prev);
    currentSession = {
      templateId: day.id,
      date: todayISO(),
      notes:"",
      exercises: prevSession.exercises.map(ex=>({name:ex.name, sets: (ex.sets||[]).map(s=>({reps:s.reps,kg:s.kg}))}))
    };
    updateTabs(day);
    renderSetTable();
  });

  $("wo_save").addEventListener("click", ()=>{
    const day=findDay(activeDayId);
    if(!day) return;
    currentSession.date = $("wo_date").value || todayISO();
    const payload = {
      id: uid(),
      date: currentSession.date,
      templateId: day.id,
      title: day.name,
      sessionNotes: $("wo_notes").value.trim() || undefined,
      coachNotes: $("wo_coach").value.trim() || undefined,
      exercises: currentSession.exercises.map(ex=>({
        name: ex.name,
        sets: (ex.sets||[]).map(s=>({reps:s.reps, kg:s.kg})).filter(s=>String(s.reps).trim()!==""||String(s.kg).trim()!=="")
      }))
    };
    store.workouts.unshift(payload);
    store.coach.workouts = $("wo_coach").value;
    save();
    alert("Saved workout!");
    renderDashboard();
  });

  // Timer
  let restLeft=180;
  let timer=null;
  const fmt=(sec)=>String(Math.floor(sec/60)).padStart(2,"0")+":"+String(sec%60).padStart(2,"0");
  function beep2s(){
    try{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator();
      const gain=ctx.createGain();
      osc.type="sine"; osc.frequency.value=880;
      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.22, ctx.currentTime+0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+2.0);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime+2.05);
      osc.onended=()=>ctx.close().catch(()=>{});
    }catch(e){}
  }
  function renderTimer(){ $("timerVal").textContent = fmt(restLeft); }
  renderTimer();
  $("timerBtn").addEventListener("click", ()=>{
    if(timer){ clearInterval(timer); timer=null; restLeft=180; renderTimer(); $("timerBtn").textContent="Start Timer"; return; }
    $("timerBtn").textContent="Reset";
    timer=setInterval(()=>{
      restLeft=Math.max(0, restLeft-1);
      renderTimer();
      if(restLeft<=0){
        clearInterval(timer); timer=null;
        $("timerBtn").textContent="Start Timer";
        restLeft=180; renderTimer();
        beep2s();
      }
    }, 1000);
  });

  // Manage days
  function refreshDaySelect(){
    const sel=$("day_select");
    sel.innerHTML="";
    (store.workoutDays||[]).forEach(d=>{
      const o=document.createElement("option");
      o.value=d.id; o.textContent=d.name;
      sel.append(o);
    });
  }
  function getSelectedDay(){ return (store.workoutDays||[]).find(d=>d.id===$("day_select").value) || null; }
  const WEEK=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  let editingDayId=null;
  let editingScheduled=new Set();

  function renderWeekdayChecks(){
    const wrap=$("weekdayChecks");
    wrap.innerHTML="";
    WEEK.forEach((lab,i)=>{
      const b=document.createElement("button");
      b.className="btnSm";
      b.textContent=lab;
      b.style.background = editingScheduled.has(i) ? "rgba(34,197,94,.22)" : "rgba(255,255,255,.06)";
      b.style.borderColor = editingScheduled.has(i) ? "rgba(34,197,94,.35)" : "rgba(255,255,255,.14)";
      b.onclick=()=>{
        editingScheduled.has(i) ? editingScheduled.delete(i) : editingScheduled.add(i);
        renderWeekdayChecks();
      };
      wrap.append(b);
    });
  }

  function openManage(){
    refreshDaySelect();
    $("manageDaysSheet").classList.remove("hidden");
  }
  $("manageDaysBtn").addEventListener("click", openManage);

  // Quick edit for exercises while in a session
  const editDayBtn = document.getElementById("wo_edit_day");
  if(editDayBtn){
    editDayBtn.addEventListener("click", ()=>{
      openManage();
      // Try to preselect the active day in the dropdown
      try{
        if(activeDayId) document.getElementById("day_select").value = activeDayId;
      }catch(e){}
    });
  }

  $("closeManage").addEventListener("click", ()=> $("manageDaysSheet").classList.add("hidden"));

  function showEditor(mode){
    const ed=$("day_editor");
    ed.classList.remove("hidden");
    if(mode==="new"){
      editingDayId=null;
      $("day_name").value="";
      $("day_notes").value="";
      $("day_exercises").value="Bench Press x3\nOverhead Press x3\nTricep Extensions x3";
      editingScheduled=new Set();
    }else{
      const d=getSelectedDay();
      if(!d) return;
      editingDayId=d.id;
      $("day_name").value=d.name;
      $("day_notes").value=d.notes||"";
      $("day_exercises").value=(d.exercises||[]).map(ex=>`${ex.name} x${ex.defaultSets||3}`).join("\n");
      editingScheduled=new Set(d.scheduled||[]);
    }
    renderWeekdayChecks();
  }
  function hideEditor(){ $("day_editor").classList.add("hidden"); editingDayId=null; editingScheduled=new Set(); }

  $("day_new").addEventListener("click", ()=>showEditor("new"));
  $("day_edit").addEventListener("click", ()=>showEditor("edit"));
  $("day_cancel").addEventListener("click", hideEditor);

  $("day_save").addEventListener("click", ()=>{
    const name=$("day_name").value.trim();
    if(!name){alert("Name required");return;}
    const notes=$("day_notes").value.trim();
    const parsed=$("day_exercises").value.split("\n").map(s=>s.trim()).filter(Boolean).map(line=>{
      const m=line.match(/^(.*?)(?:\s*[xX]\s*(\d+))?\s*$/);
      const n=(m?.[1]||line).trim();
      const sets=m?.[2]?Math.max(1,Number(m[2])):3;
      return {name:n, defaultSets:sets};
    });
    const scheduled=Array.from(editingScheduled).sort((a,b)=>a-b);
    if(editingDayId){
      store.workoutDays=store.workoutDays.map(d=>d.id===editingDayId?({...d,name,notes,scheduled,exercises:parsed}):d);
    }else{
      store.workoutDays.push({id:uid(),name,notes,scheduled,exercises:parsed});
    }
    save();
    hideEditor();
    refreshDaySelect();
    renderWorkoutDays();
    alert("Saved day");
  });

  $("day_delete").addEventListener("click", ()=>{
    const d=getSelectedDay(); if(!d) return;
    if(confirm(`Delete "${d.name}"?`)){
      store.workoutDays=store.workoutDays.filter(x=>x.id!==d.id);
      save();
      refreshDaySelect();
      renderWorkoutDays();
      hideEditor();
    }
  });

  // Dashboard tiles nav
  document.querySelectorAll(".stat[data-nav]").forEach(el=>{
    el.addEventListener("click", ()=> setPage(el.getAttribute("data-nav")));
  });

  // Init defaults
  renderDashboard();
  renderMealsPage();
  renderWeightPage();
  renderProgressPage();
  renderStepsPage();
})();
</script>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}
</script>
</body>
</html>
