<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0b1020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <title>Fitness Log</title>
  <style>
    :root{
      --bg0:#070b16;
      --bg1:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.045);
      --stroke:rgba(255,255,255,.10);
      --text:#f4f7ff;
      --muted:rgba(244,247,255,.72);
      --muted2:rgba(244,247,255,.56);
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r:24px;
      --r2:18px;
      --gradBlue:linear-gradient(135deg,#4facfe 0%, #00f2fe 100%);
      --gradPink:linear-gradient(135deg,#f857a6 0%, #ff5858 100%);
      --gradPurple:linear-gradient(135deg,#7f00ff 0%, #e100ff 100%);
      --gradAmber:linear-gradient(135deg,#f7971e 0%, #ffd200 100%);
      --gradGreen:linear-gradient(135deg,#00c853 0%, #b2ff59 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 900px at 20% 0%, rgba(127,0,255,.28), transparent 60%),
        radial-gradient(1200px 900px at 80% 10%, rgba(0,242,254,.18), transparent 55%),
        radial-gradient(1200px 900px at 50% 120%, rgba(255,88,88,.16), transparent 55%),
        linear-gradient(180deg,var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
      gap:10px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 6px 6px 6px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:34px; height:34px; border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
    }
    .logo span{font-size:18px}
    .brandTitle{font-weight:950; letter-spacing:.2px}
    .brandSub{font-size:12px; color:var(--muted2); margin-top:1px}
    .iconBtn{
      width:40px; height:40px; border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform:translateY(1px)}
    .page{
      flex:1;
      display:none;
      overflow:hidden;
    }
    .page.active{display:flex; flex-direction:column; gap:10px;}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .dashboard{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }
    .tiles{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .tile{
      position:relative;
      padding:14px;
      border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      min-height:90px;
    }
    .tile::before{
      content:"";
      position:absolute; inset:-2px;
      background:linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,0));
      opacity:.55;
    }
    .tile::after{
      content:"";
      position:absolute; inset:0;
      background:var(--gradBlue);
      opacity:.10;
      mix-blend-mode:screen;
    }
    .tile[data-grad="pink"]::after{background:var(--gradPink)}
    .tile[data-grad="amber"]::after{background:var(--gradAmber)}
    .tile[data-grad="purple"]::after{background:var(--gradPurple)}
    .tile[data-grad="green"]::after{background:var(--gradGreen)}
    .tileInner{position:relative; z-index:2; display:flex; flex-direction:column; gap:6px;}
    .tileTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .tileTitle{font-weight:900; letter-spacing:.15px}
    .tileIcon{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
    }
    .tileValue{font-size:22px; font-weight:950; line-height:1;}
    .tileSub{font-size:12px; color:var(--muted2)}
    .rings{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px;
      overflow:hidden;
    }
    .ringCard{padding:14px; border-radius:22px;}
    .ringRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .ringLabel{font-weight:900}
    .ringMeta{font-size:12px; color:var(--muted2); margin-top:2px}
    .ringSvg{width:74px; height:74px}
    .ringValue{font-weight:950; font-size:16px}
    .ringSmall{font-size:11px; color:var(--muted2); margin-top:2px}
    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
    }
    .tbTitle{font-weight:950}
    .tbSub{font-size:12px; color:var(--muted2)}
    .content{
      flex:1;
      overflow:auto;
      padding:0 0 6px 0;
      scrollbar-width:none;
    }
    .content::-webkit-scrollbar{display:none}
    .section{padding:12px}
    label{display:block; font-size:12px; color:var(--muted2); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:none; cursor:pointer;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      background:rgba(255,255,255,.10);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
    }
    .btn.primary{background:var(--gradBlue); color:#071019; border:none}
    .btn.pink{background:var(--gradPink); color:#140a10; border:none}
    .btn.purple{background:var(--gradPurple); color:#fff; border:none}
    .btn.amber{background:var(--gradAmber); color:#160f00; border:none}
    .btn.danger{background:rgba(255,80,80,.18); border:1px solid rgba(255,80,80,.30)}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .item{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .itemTitle{font-weight:950}
    .itemMeta{font-size:12px; color:var(--muted2); margin-top:3px}
    .itemBody{font-size:13px; color:var(--muted); margin-top:8px; white-space:pre-wrap}
    .itemActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill.on{background:rgba(0,200,83,.18); border-color:rgba(0,200,83,.35)}
    .muted{color:var(--muted2)}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
      margin-top:10px;
    }
    .table th{
      text-align:left;
      font-size:12px;
      color:var(--muted2);
      font-weight:900;
      padding:0 8px;
    }
    .table td{
      padding:10px 8px;
      background:rgba(255,255,255,.04);
      border-top:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .table tr td:first-child{border-left:1px solid rgba(255,255,255,.10); border-top-left-radius:16px; border-bottom-left-radius:16px}
    .table tr td:last-child{border-right:1px solid rgba(255,255,255,.10); border-top-right-radius:16px; border-bottom-right-radius:16px}
    .lock{
      opacity:.70;
      pointer-events:none;
    }
    .restBar{
      position:sticky;
      bottom:0;
      padding:10px;
      margin-top:10px;
      border-radius:22px;
      background:rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .restTime{font-weight:950; font-size:16px}
    .tiny{font-size:12px; color:var(--muted2)}
    .modal{
      position:fixed; inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      padding:18px 12px;
    }
    .modal.on{display:flex; align-items:flex-end; justify-content:center;}
    .sheet{
      width:100%;
      max-width:520px;
      border-radius:28px;
      padding:14px;
      background:rgba(12,16,32,.92);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
    }
    .sheetTop{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 4px 10px}
    .sheetTitle{font-weight:950}
    .hr{height:1px; background:rgba(255,255,255,.10); margin:10px 0}
    .toast{
      position:fixed;
      left:12px; right:12px; bottom:12px;
      background:rgba(0,0,0,.52);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:16px;
      display:none;
      box-shadow: var(--shadow);
      font-size:13px;
    }
    .toast.on{display:block}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>üí™</span></div>
        <div>
          <div class="brandTitle">Fitness Log</div>
          <div class="brandSub" id="brandSub">Local tracker</div>
        </div>
      </div>
      <div style="display:flex; gap:10px">
        <div class="iconBtn" id="btnSettings" title="Settings">‚öôÔ∏è</div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="dashboard">
        <div class="tiles">
          <div class="tile" data-go="workouts" data-grad="green">
            <div class="tileInner">
              <div class="tileTop">
                <div>
                  <div class="tileTitle">Workouts</div>
                  <div class="tileSub" id="dashWorkoutSub">This week: 0</div>
                </div>
                <div class="tileIcon">üèãÔ∏è</div>
              </div>
              <div class="tileValue" id="dashWorkouts">0</div>
              <div class="tileSub">Sessions this week</div>
            </div>
          </div>

          <div class="tile" data-go="meals" data-grad="amber">
            <div class="tileInner">
              <div class="tileTop">
                <div>
                  <div class="tileTitle">Calories</div>
                  <div class="tileSub" id="dashCalsSub">Today</div>
                </div>
                <div class="tileIcon">üçΩÔ∏è</div>
              </div>
              <div class="tileValue"><span id="dashCalsLeft">‚Äî</span></div>
              <div class="tileSub"><span id="dashCalsLeftLabel">Left</span> ‚Ä¢ Consumed: <span id="dashCalsConsumed">0</span></div>
            </div>
          </div>

          <div class="tile" data-go="weight" data-grad="pink">
            <div class="tileInner">
              <div class="tileTop">
                <div>
                  <div class="tileTitle">Weight</div>
                  <div class="tileSub" id="dashWeightSub">Last: ‚Äî</div>
                </div>
                <div class="tileIcon">‚öñÔ∏è</div>
              </div>
              <div class="tileValue" id="dashWeight">‚Äî</div>
              <div class="tileSub">Tap to log</div>
            </div>
          </div>

          <div class="tile" data-go="steps" data-grad="amber">
            <div class="tileInner">
              <div class="tileTop">
                <div>
                  <div class="tileTitle">Steps</div>
                  <div class="tileSub" id="dashStepsSub">Target: ‚Äî</div>
                </div>
                <div class="tileIcon">üëü</div>
              </div>
              <div class="tileValue" id="dashSteps">0</div>
              <div class="tileSub">Today</div>
            </div>
          </div>

          <div class="tile" data-go="cardio" data-grad="purple">
            <div class="tileInner">
              <div class="tileTop">
                <div>
                  <div class="tileTitle">Cardio</div>
                  <div class="tileSub" id="dashCardioSub">This month</div>
                </div>
                <div class="tileIcon">üèÉ</div>
              </div>
              <div class="tileValue" id="dashCardio">0</div>
              <div class="tileSub"><span id="dashCardioKm">0.0</span> km this month</div>
            </div>
          </div>

          <div class="tile" data-go="progress" data-grad="blue">
            <div class="tileInner">
              <div class="tileTop">
                <div>
                  <div class="tileTitle">Progress</div>
                  <div class="tileSub" id="dashProgSub">Notes / waist</div>
                </div>
                <div class="tileIcon">üìà</div>
              </div>
              <div class="tileValue" id="dashProgCount">0</div>
              <div class="tileSub">Entries</div>
            </div>
          </div>
        </div>

        <div class="rings">
          <div class="card ringCard">
            <div class="ringRow">
              <div>
                <div class="ringLabel">Calories</div>
                <div class="ringMeta" id="calMeta">Target ‚Äî</div>
              </div>
              <svg class="ringSvg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="38" stroke="rgba(255,255,255,.14)" stroke-width="10" fill="none"/>
                <circle id="calRing" cx="50" cy="50" r="38" stroke="#00f2fe" stroke-width="10" fill="none"
                        stroke-linecap="round" transform="rotate(-90 50 50)" stroke-dasharray="0 999"/>
              </svg>
            </div>
            <div class="ringValue"><span id="calVal">0</span> / <span id="calTarget">0</span></div>
            <div class="ringSmall" id="calHint">Logged today</div>
          </div>

          <div class="card ringCard">
            <div class="ringRow">
              <div>
                <div class="ringLabel">Protein</div>
                <div class="ringMeta" id="proMeta">Target ‚Äî</div>
              </div>
              <svg class="ringSvg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="38" stroke="rgba(255,255,255,.14)" stroke-width="10" fill="none"/>
                <circle id="proRing" cx="50" cy="50" r="38" stroke="#b2ff59" stroke-width="10" fill="none"
                        stroke-linecap="round" transform="rotate(-90 50 50)" stroke-dasharray="0 999"/>
              </svg>
            </div>
            <div class="ringValue"><span id="proVal">0</span>g / <span id="proTarget">0</span>g</div>
            <div class="ringSmall" id="proHint">Logged today</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKOUTS -->
    <div class="page" id="page-workouts">
      <div class="toolbar card">
        <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        <div style="flex:1">
          <div class="tbTitle">Workouts</div>
          <div class="tbSub">Pick a day ‚Ä¢ log sets ‚Ä¢ see last session</div>
        </div>
        <div class="iconBtn" id="btnManageDays" title="Manage days">üóìÔ∏è</div>
      </div>

      <div class="content">
        <div class="section card" style="padding:12px">
          <div class="tbTitle">Training Days</div>
          <div class="tbSub">Green ring = scheduled day</div>
          <div class="pillRow" id="dayPills"></div>
        </div>

        <div class="section card" style="padding:12px; margin-top:10px">
          <div class="tbTitle" id="woDayTitle">Select a day</div>
          <div class="tbSub" id="woDaySub">Then choose an exercise</div>

          <div class="pillRow" id="exPills"></div>

          <div id="sessionArea" style="display:none">
            <div class="hr"></div>
            <div class="tbTitle" id="exTitle">Exercise</div>
            <div class="tbSub">Last session is locked (reference). Log today on the right.</div>

            <table class="table" id="setTable">
              <thead>
                <tr>
                  <th style="width:34px">#</th>
                  <th>Last</th>
                  <th>Today</th>
                </tr>
              </thead>
              <tbody id="setTbody"></tbody>
            </table>

            <div class="btnRow">
              <button class="btn" id="btnAddSet">+ Set</button>
              <button class="btn danger" id="btnDelSet">Remove set</button>
              <button class="btn primary" id="btnSaveWorkout">Save session</button>
            </div>

            <div class="restBar">
              <div>
                <div class="restTime" id="restTime">03:00</div>
                <div class="tiny" id="restState">Rest timer</div>
              </div>
              <div style="display:flex; gap:10px">
                <button class="btn" id="restStart">Start</button>
                <button class="btn" id="restReset">Reset</button>
              </div>
            </div>
          </div>

        </div>

        <div class="section card" style="padding:12px; margin-top:10px">
          <div class="tbTitle">Coach Notes</div>
          <div class="tbSub">Optional reminders for next time</div>
          <textarea id="coach_workouts" placeholder="E.g., add 2.5kg next week on incline press, keep 1‚Äì2 reps in reserve‚Ä¶"></textarea>
          <div class="btnRow">
            <button class="btn primary" id="saveCoachWorkouts">Save notes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MEALS -->
    <div class="page" id="page-meals">
      <div class="toolbar card">
        <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        <div style="flex:1">
          <div class="tbTitle">Meals</div>
          <div class="tbSub">Log calories & protein ‚Ä¢ save presets</div>
        </div>
        <div class="iconBtn" id="btnExport" title="Export/Import">‚ÜïÔ∏è</div>
      </div>

      <div class="content">
        <div class="section card" style="padding:12px">
          <div class="tbTitle">Add meal</div>
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="m_date">
            </div>
            <div>
              <label>Meal name</label>
              <input id="m_title" placeholder="Chicken & rice">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Calories</label>
              <input id="m_cals" inputmode="numeric" placeholder="650">
            </div>
            <div>
              <label>Protein (g)</label>
              <input id="m_pro" inputmode="numeric" placeholder="45">
            </div>
          </div>
          <label>Notes</label>
          <textarea id="m_notes" placeholder="Optional‚Ä¶"></textarea>
          <div class="btnRow">
            <button class="btn amber" id="btnSaveMeal">Add</button>
            <button class="btn" id="btnSavePreset">Save as preset</button>
            <button class="btn danger" id="btnClearMeal">Clear</button>
          </div>
        </div>

        <div class="section card" style="padding:12px; margin-top:10px">
          <div class="tbTitle">Saved meals</div>
          <div class="tbSub">Tap to auto-fill. Long-press to delete.</div>
          <div class="pillRow" id="presetPills"></div>
        </div>

        <div class="section card" style="padding:12px; margin-top:10px">
          <div class="tbTitle">Today</div>
          <div class="tbSub" id="mealsTodayMeta">‚Äî</div>
          <div class="list" id="mealsList"></div>
        </div>

        <div class="section card" style="padding:12px; margin-top:10px">
          <div class="tbTitle">Coach Notes</div>
          <div class="tbSub">Optional nutrition reminders</div>
          <textarea id="coach_meals" placeholder="E.g., add 30g protein to breakfast, keep snacks planned‚Ä¶"></textarea>
          <div class="btnRow">
            <button class="btn primary" id="saveCoachMeals">Save notes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WEIGHT -->
    <div class="page" id="page-weight">
      <div class="toolbar card">
        <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        <div style="flex:1">
          <div class="tbTitle">Weight</div>
          <div class="tbSub">Quick weigh-in log</div>
        </div>
        <div class="iconBtn">‚öñÔ∏è</div>
      </div>
      <div class="content">
        <div class="section card" style="padding:12px">
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="w_date">
            </div>
            <div>
              <label>Weight (kg)</label>
              <input id="w_kg" inputmode="decimal" placeholder="84.5">
            </div>
          </div>
          <label>Notes</label>
          <textarea id="w_notes" placeholder="Sleep, stress, salt, etc."></textarea>
          <div class="btnRow">
            <button class="btn pink" id="btnSaveWeight">Add</button>
            <button class="btn danger" id="btnClearWeight">Clear</button>
          </div>
          <div class="list" id="weightList"></div>
        </div>
      </div>
    </div>

    <!-- STEPS -->
    <div class="page" id="page-steps">
      <div class="toolbar card">
        <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        <div style="flex:1">
          <div class="tbTitle">Steps</div>
          <div class="tbSub">Manual daily steps (target in Settings)</div>
        </div>
        <div class="iconBtn">üëü</div>
      </div>
      <div class="content">
        <div class="section card" style="padding:12px">
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="s_date">
            </div>
            <div>
              <label>Steps</label>
              <input id="s_steps" inputmode="numeric" placeholder="8000">
            </div>
          </div>
          <div class="btnRow">
            <button class="btn amber" id="btnSaveSteps">Add</button>
            <button class="btn danger" id="btnClearSteps">Clear</button>
          </div>
          <div class="list" id="stepsList"></div>
        </div>
      </div>
    </div>

    <!-- CARDIO -->
    <div class="page" id="page-cardio">
      <div class="toolbar card">
        <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        <div style="flex:1">
          <div class="tbTitle">Cardio</div>
          <div class="tbSub">Runs / cardio sessions (pace auto)</div>
        </div>
        <div class="iconBtn">üèÉ</div>
      </div>
      <div class="content">
        <div class="section card" style="padding:12px">
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="c_date">
            </div>
            <div>
              <label>Type</label>
              <select id="c_type">
                <option>Run</option><option>Treadmill</option><option>Bike</option><option>Row</option><option>Other</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Distance (km)</label>
              <input id="c_km" inputmode="decimal" placeholder="5.0">
            </div>
            <div>
              <label>Time (mm:ss)</label>
              <input id="c_time" placeholder="25:30">
            </div>
          </div>
          <label>Notes</label>
          <textarea id="c_notes" placeholder="Intervals, HR, route‚Ä¶"></textarea>
          <div class="btnRow">
            <button class="btn purple" id="btnSaveCardio">Add</button>
            <button class="btn danger" id="btnClearCardio">Clear</button>
          </div>
          <div class="list" id="cardioList"></div>
        </div>
      </div>
    </div>

    <!-- PROGRESS -->
    <div class="page" id="page-progress">
      <div class="toolbar card">
        <div class="iconBtn" data-back="dashboard">‚Äπ</div>
        <div style="flex:1">
          <div class="tbTitle">Progress</div>
          <div class="tbSub">Waist / photos notes / weekly check-in</div>
        </div>
        <div class="iconBtn">üìà</div>
      </div>
      <div class="content">
        <div class="section card" style="padding:12px">
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="p_date">
            </div>
            <div>
              <label>Waist (cm)</label>
              <input id="p_waist" inputmode="decimal" placeholder="‚Äî">
            </div>
          </div>
          <label>Notes</label>
          <textarea id="p_notes" placeholder="How you‚Äôre feeling, photos taken, strength PRs‚Ä¶"></textarea>
          <div class="btnRow">
            <button class="btn primary" id="btnSaveProg">Add</button>
            <button class="btn danger" id="btnClearProg">Clear</button>
          </div>
          <div class="list" id="progList"></div>
        </div>
      </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="settingsModal">
      <div class="sheet">
        <div class="sheetTop">
          <div>
            <div class="sheetTitle">Settings</div>
            <div class="tbSub">Targets & basics</div>
          </div>
          <div class="iconBtn" id="closeSettings">‚úï</div>
        </div>
        <div class="hr"></div>

        <div class="row">
          <div>
            <label>Calorie target</label>
            <input id="t_cal" inputmode="numeric" placeholder="2200">
          </div>
          <div>
            <label>Protein target (g)</label>
            <input id="t_pro" inputmode="numeric" placeholder="170">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Steps target</label>
            <input id="t_steps" inputmode="numeric" placeholder="8000">
          </div>
          <div>
            <label>Workout schedule</label>
            <select id="t_sched">
              <option value="PPL">Push/Pull/Legs (3)</option>
              <option value="PPLx2">PPL x2 (6)</option>
              <option value="Custom">Custom</option>
            </select>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnSaveSettings">Save</button>
          <button class="btn danger" id="btnResetAll">Reset all data</button>
        </div>

        <div class="hr"></div>
        <div class="tbSub muted">Everything is stored locally on your phone.</div>
      </div>
    </div>

    <div class="modal" id="daysModal">
      <div class="sheet">
        <div class="sheetTop">
          <div>
            <div class="sheetTitle">Manage Workout Days</div>
            <div class="tbSub">Create days and edit exercises (one per line)</div>
          </div>
          <div class="iconBtn" id="closeDays">‚úï</div>
        </div>
        <div class="hr"></div>

        <label>Day</label>
        <select id="daySelect"></select>

        <div class="row">
          <button class="btn" id="btnAddDay">+ Day</button>
          <button class="btn danger" id="btnDelDay">Delete day</button>
        </div>

        <label>Day name</label>
        <input id="dayName" placeholder="Push">

        <label>Scheduled day (green ring)</label>
        <select id="dayScheduled">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>

        <label>Exercises (one per line)</label>
        <textarea id="dayExercises" placeholder="Bench Press&#10;Incline DB Press&#10;Shoulder Press"></textarea>

        <div class="btnRow">
          <button class="btn primary" id="btnSaveDay">Save changes</button>
        </div>
      </div>
    </div>

    <div class="modal" id="ioModal">
      <div class="sheet">
        <div class="sheetTop">
          <div>
            <div class="sheetTitle">Export / Import</div>
            <div class="tbSub">Backup your local data</div>
          </div>
          <div class="iconBtn" id="closeIO">‚úï</div>
        </div>
        <div class="hr"></div>
        <button class="btn primary" id="btnExportJson">Export (copy)</button>
        <label style="margin-top:12px">Import JSON</label>
        <textarea id="importBox" placeholder="Paste backup JSON here‚Ä¶"></textarea>
        <div class="btnRow">
          <button class="btn" id="btnImportJson">Import</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  const VERSION = "fresh-v1";
  const KEY = "fitness_log_fresh_v1";
  const $ = (id)=>document.getElementById(id);
  const pages = {
    dashboard: $("page-dashboard"),
    workouts: $("page-workouts"),
    meals: $("page-meals"),
    weight: $("page-weight"),
    steps: $("page-steps"),
    cardio: $("page-cardio"),
    progress: $("page-progress"),
  };

  const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  const todayISO = () => new Date().toISOString().slice(0,10);
  const isSameWeek = (d1, d2) => {
    // ISO week-ish: compare Monday start
    const a = new Date(d1), b = new Date(d2);
    const monday = (dt)=>{
      const x = new Date(dt);
      const day = (x.getDay()+6)%7; // Mon=0
      x.setDate(x.getDate()-day);
      x.setHours(0,0,0,0);
      return x;
    };
    return monday(a).getTime() === monday(b).getTime();
  };
  const isSameMonth = (d1, d2) => String(d1||"").slice(0,7) === String(d2||"").slice(0,7);

  const defaultStore = () => ({
    version: VERSION,
    targets: { calories: 2200, proteinG: 170, steps: 8000 },
    coach: { workouts: "", meals: "" },
    weights: [],
    meals: [],
    savedMeals: [],
    steps: [],
    cardio: [],
    progress: [],
    workoutDays: [
      { id: uid(), name: "Push", scheduled: true, exercises: ["Bench Press","Incline DB Press","Shoulder Press","Triceps Pushdown"] },
      { id: uid(), name: "Pull", scheduled: true, exercises: ["Lat Pulldown","Barbell Row","Face Pull","Biceps Curl"] },
      { id: uid(), name: "Legs", scheduled: true, exercises: ["Squat","RDL","Leg Press","Calf Raise"] },
    ],
    workoutHistory: [] // {id, dayId, date, exercises:[{name, sets:[{reps,kg}]}]}
  });

  const load = () => {
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return defaultStore();
      const s = JSON.parse(raw);
      return { ...defaultStore(), ...s, targets:{...defaultStore().targets, ...(s.targets||{})}, coach:{...defaultStore().coach, ...(s.coach||{})} };
    }catch(e){
      console.warn("load failed", e);
      return defaultStore();
    }
  };
  let store = load();
  const save = () => localStorage.setItem(KEY, JSON.stringify(store));

  // Toast
  let toastT=null;
  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("on");
    clearTimeout(toastT);
    toastT = setTimeout(()=>t.classList.remove("on"), 2200);
  };

  // Navigation
  const setPage = (name) => {
    Object.values(pages).forEach(p=>p.classList.remove("active"));
    pages[name].classList.add("active");
    if(name==="dashboard") renderDashboard();
    if(name==="workouts") renderWorkouts();
    if(name==="meals") renderMeals();
    if(name==="weight") renderWeight();
    if(name==="steps") renderSteps();
    if(name==="cardio") renderCardio();
    if(name==="progress") renderProgress();
  };

  document.querySelectorAll("[data-go]").forEach(el=>{
    el.addEventListener("click", ()=> setPage(el.getAttribute("data-go")));
  });
  document.querySelectorAll("[data-back]").forEach(el=>{
    el.addEventListener("click", ()=> setPage(el.getAttribute("data-back")));
  });

  // Settings modal
  const openSettings = () => {
    $("t_cal").value = store.targets.calories ?? "";
    $("t_pro").value = store.targets.proteinG ?? "";
    $("t_steps").value = store.targets.steps ?? "";
    $("t_sched").value = "Custom";
    $("settingsModal").classList.add("on");
  };
  $("btnSettings").addEventListener("click", openSettings);
  $("closeSettings").addEventListener("click", ()=> $("settingsModal").classList.remove("on"));
  $("btnSaveSettings").addEventListener("click", ()=>{
    const c = Number($("t_cal").value);
    const p = Number($("t_pro").value);
    const s = Number($("t_steps").value);
    if(Number.isFinite(c) && c>0) store.targets.calories = Math.round(c);
    if(Number.isFinite(p) && p>0) store.targets.proteinG = Math.round(p);
    if(Number.isFinite(s) && s>0) store.targets.steps = Math.round(s);
    save();
    $("settingsModal").classList.remove("on");
    renderDashboard();
    toast("Saved settings");
  });
  $("btnResetAll").addEventListener("click", ()=>{
    if(!confirm("Reset ALL data? This cannot be undone.")) return;
    store = defaultStore();
    save();
    $("settingsModal").classList.remove("on");
    setPage("dashboard");
    toast("Reset complete");
  });

  // --- Dashboard ---
  const sumMeals = (date) => {
    const m = store.meals.filter(x=>x.date===date);
    const c = m.reduce((a,b)=>a+(Number(b.calories)||0),0);
    const p = m.reduce((a,b)=>a+(Number(b.proteinG)||0),0);
    return {c,p,count:m.length};
  };
  const workoutsThisWeek = () => {
    const t = todayISO();
    const uniq = new Set(store.workoutHistory.filter(w=>isSameWeek(w.date,t)).map(w=>w.id));
    return uniq.size;
  };
  function setRing(circleId, progress){
    const c = $(circleId);
    const r = 38;
    const circ = 2*Math.PI*r;
    const pct = Math.max(0, Math.min(1, progress));
    c.setAttribute("stroke-dasharray", `${(pct*circ).toFixed(2)} ${(circ).toFixed(2)}`);
  }
  function renderDashboard(){
    const t = todayISO();
    $("brandSub").textContent = `Local tracker ‚Ä¢ ${t}`;
    // workouts
    const w = workoutsThisWeek();
    $("dashWorkouts").textContent = String(w);
    $("dashWorkoutSub").textContent = `This week: ${w}`;

    // meals cals left
    const {c,p} = sumMeals(t);
    const tC = Number(store.targets.calories||0);
    const tP = Number(store.targets.proteinG||0);
    const left = (tC>0) ? (tC - c) : 0;
    $("dashCalsLeft").textContent = (tC>0) ? String(Math.max(0,left)) : String(c);
    $("dashCalsLeftLabel").textContent = (tC>0) ? (left>=0 ? "Left" : "Over") : "Logged";
    $("dashCalsConsumed").textContent = String(c);
    // ring meta
    $("calMeta").textContent = tC>0 ? `Target ${tC}` : "Set target in Settings";
    $("proMeta").textContent = tP>0 ? `Target ${tP}g` : "Set target in Settings";
    $("calVal").textContent = String(c);
    $("calTarget").textContent = String(tC||0);
    $("proVal").textContent = String(p);
    $("proTarget").textContent = String(tP||0);
    setRing("calRing", tC>0 ? c/tC : 0);
    setRing("proRing", tP>0 ? p/tP : 0);

    // weight
    const lastW = store.weights.slice().sort((a,b)=>a.date<b.date?1:-1)[0];
    $("dashWeight").textContent = lastW ? `${Number(lastW.kg).toFixed(1)} kg` : "‚Äî";
    $("dashWeightSub").textContent = lastW ? `Last: ${lastW.date}` : "Last: ‚Äî";

    // steps
    const st = Number(store.targets.steps||0);
    const sEntry = store.steps.find(x=>x.date===t);
    const sVal = sEntry ? Number(sEntry.steps)||0 : 0;
    $("dashSteps").textContent = String(sVal);
    $("dashStepsSub").textContent = st>0 ? `Target: ${st}` : "Target: ‚Äî";

    // cardio
    const month = store.cardio.filter(x=>x.date && isSameMonth(x.date,t));
    const km = month.reduce((a,b)=>a+(Number(b.km)||0),0);
    $("dashCardio").textContent = String(month.length);
    $("dashCardioKm").textContent = km.toFixed(1);

    // progress
    $("dashProgCount").textContent = String(store.progress.length||0);
  }

  // --- Workouts ---
  let activeDayId = null;
  let activeEx = null; // name
  let sessionToday = null; // {dayId,date,exercises:...}
  let restTimer = { running:false, endAt:0, interval:null, totalSec:180 };
  const beep = async () => {
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine"; o.frequency.value=880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.value=0.001;
      o.start();
      const start = ctx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.35, start+0.02);
      g.gain.exponentialRampToValueAtTime(0.001, start+2.0);
      o.stop(start+2.05);
      setTimeout(()=>ctx.close(), 2200);
    }catch(e){}
  };
  const fmtMMSS = (sec) => {
    const s = Math.max(0, Math.floor(sec));
    const m = Math.floor(s/60);
    const r = s%60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  };
  const restRender = () => {
    const now = Date.now();
    let remain = restTimer.running ? Math.max(0, Math.ceil((restTimer.endAt-now)/1000)) : restTimer.totalSec;
    $("restTime").textContent = fmtMMSS(remain);
    $("restState").textContent = restTimer.running ? "Rest running‚Ä¶" : "Rest timer";
  };
  const restStop = () => {
    restTimer.running=false;
    if(restTimer.interval){ clearInterval(restTimer.interval); restTimer.interval=null; }
    restRender();
  };
  $("restStart").addEventListener("click", ()=>{
    restTimer.totalSec = 180;
    restTimer.running=true;
    restTimer.endAt = Date.now() + restTimer.totalSec*1000;
    if(restTimer.interval) clearInterval(restTimer.interval);
    restTimer.interval = setInterval(()=>{
      const remain = Math.ceil((restTimer.endAt-Date.now())/1000);
      if(remain<=0){
        restStop();
        beep();
      } else {
        restRender();
      }
    }, 250);
    restRender();
  });
  $("restReset").addEventListener("click", ()=>{ restStop(); });

  function getDay(dayId){ return store.workoutDays.find(d=>d.id===dayId); }
  function lastSessionForDay(dayId){
    return store.workoutHistory
      .filter(w=>w.dayId===dayId)
      .slice()
      .sort((a,b)=>a.date<b.date?1:-1)[0] || null;
  }
  function ensureTodaySession(dayId){
    const t = todayISO();
    // temp session not saved until user saves
    if(sessionToday && sessionToday.dayId===dayId && sessionToday.date===t) return sessionToday;
    const day = getDay(dayId);
    const ex = day.exercises.map(name=>({name, sets:[{reps:"",kg:""},{reps:"",kg:""},{reps:"",kg:""}]}));
    sessionToday = { id: uid(), dayId, date:t, exercises: ex };
    return sessionToday;
  }
  function renderDayPills(){
    const wrap = $("dayPills");
    wrap.innerHTML = "";
    store.workoutDays.forEach(d=>{
      const p = document.createElement("div");
      p.className = "pill" + (d.scheduled ? " on" : "");
      p.textContent = d.name;
      p.onclick = ()=> {
        activeDayId = d.id;
        activeEx = null;
        sessionToday = null;
        renderWorkouts();
      };
      wrap.append(p);
    });
    if(!store.workoutDays.length){
      const e = document.createElement("div");
      e.className="muted";
      e.textContent="No days yet. Tap üóìÔ∏è to add.";
      wrap.append(e);
    }
  }
  function renderExPills(day){
    const wrap = $("exPills");
    wrap.innerHTML = "";
    day.exercises.forEach(name=>{
      const p = document.createElement("div");
      p.className = "pill" + (activeEx===name ? " on" : "");
      p.textContent = name;
      p.onclick = ()=>{
        activeEx = name;
        $("sessionArea").style.display="block";
        restStop();
        restRender();
        renderSetTable();
      };
      wrap.append(p);
    });
    if(!day.exercises.length){
      const e = document.createElement("div");
      e.className="muted";
      e.textContent="No exercises. Tap üóìÔ∏è to add.";
      wrap.append(e);
    }
  }
  function getExerciseObj(session, name){
    return session.exercises.find(e=>e.name===name);
  }
  function renderSetTable(){
    const day = getDay(activeDayId);
    const t = todayISO();
    const session = ensureTodaySession(activeDayId);
    const ex = getExerciseObj(session, activeEx);
    $("woDayTitle").textContent = `${day.name} ‚Ä¢ ${t}`;
    $("woDaySub").textContent = `Exercises: ${day.exercises.length}`;
    $("exTitle").textContent = activeEx;

    // last session
    const last = lastSessionForDay(activeDayId);
    const lastEx = last ? last.exercises.find(e=>e.name===activeEx) : null;
    const lastSets = lastEx ? lastEx.sets : [];

    const tbody = $("setTbody");
    tbody.innerHTML = "";
    const sets = ex.sets;
    for(let i=0;i<sets.length;i++){
      const tr = document.createElement("tr");
      const lastText = lastSets[i] ? `${lastSets[i].reps||"‚Äî"} x ${lastSets[i].kg||"‚Äî"}kg` : "‚Äî";
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="lock">${lastText}</td>
        <td>
          <div style="display:flex; gap:8px">
            <input aria-label="reps" class="todayReps" inputmode="numeric" placeholder="reps" value="${sets[i].reps||""}" style="padding:10px 10px;border-radius:14px">
            <input aria-label="kg" class="todayKg" inputmode="decimal" placeholder="kg" value="${sets[i].kg||""}" style="padding:10px 10px;border-radius:14px">
          </div>
        </td>`;
      tbody.append(tr);
    }
    // wire inputs
    [...tbody.querySelectorAll("tr")].forEach((tr, idx)=>{
      tr.querySelector(".todayReps").addEventListener("input", (e)=>{ ex.sets[idx].reps = e.target.value; });
      tr.querySelector(".todayKg").addEventListener("input", (e)=>{ ex.sets[idx].kg = e.target.value; });
    });
  }
  $("btnAddSet").addEventListener("click", ()=>{
    if(!activeDayId || !activeEx) return toast("Pick a day and exercise first");
    const session = ensureTodaySession(activeDayId);
    const ex = getExerciseObj(session, activeEx);
    ex.sets.push({reps:"",kg:""});
    renderSetTable();
  });
  $("btnDelSet").addEventListener("click", ()=>{
    if(!activeDayId || !activeEx) return;
    const session = ensureTodaySession(activeDayId);
    const ex = getExerciseObj(session, activeEx);
    if(ex.sets.length<=1) return;
    ex.sets.pop();
    renderSetTable();
  });
  $("btnSaveWorkout").addEventListener("click", ()=>{
    if(!activeDayId) return toast("Pick a day first");
    const session = ensureTodaySession(activeDayId);

    // basic cleanup: keep sets where either reps or kg entered
    session.exercises.forEach(e=>{
      e.sets = e.sets.filter(s=>String(s.reps||"").trim()!=="" || String(s.kg||"").trim()!=="");
      if(!e.sets.length) e.sets = [{reps:"",kg:""}];
    });

    // store copy
    const entry = JSON.parse(JSON.stringify(session));
    store.workoutHistory.unshift(entry);
    save();
    toast("Workout saved");
    renderDashboard();
  });

  // Coach workouts notes
  function renderCoach(){
    $("coach_workouts").value = store.coach.workouts || "";
    $("coach_meals").value = store.coach.meals || "";
  }
  $("saveCoachWorkouts").addEventListener("click", ()=>{
    store.coach.workouts = $("coach_workouts").value.trim();
    save();
    toast("Saved coach notes");
  });
  $("saveCoachMeals").addEventListener("click", ()=>{
    store.coach.meals = $("coach_meals").value.trim();
    save();
    toast("Saved coach notes");
  });

  function renderWorkouts(){
    renderCoach();
    renderDayPills();
    const day = activeDayId ? getDay(activeDayId) : null;
    if(!day){
      $("woDayTitle").textContent = "Select a day";
      $("woDaySub").textContent = "Tap a day above";
      $("exPills").innerHTML = "";
      $("sessionArea").style.display="none";
      return;
    }
    renderExPills(day);
    $("woDayTitle").textContent = day.name;
    $("woDaySub").textContent = day.scheduled ? "Scheduled day" : "Optional day";
    $("sessionArea").style.display = activeEx ? "block" : "none";
    if(activeEx) { restRender(); renderSetTable(); }
  }

  // Manage workout days modal
  const openDays = ()=> { renderDaysModal(); $("daysModal").classList.add("on"); };
  const closeDays = ()=> $("daysModal").classList.remove("on");
  $("btnManageDays").addEventListener("click", openDays);
  $("closeDays").addEventListener("click", closeDays);

  function renderDaysModal(){
    const sel = $("daySelect");
    sel.innerHTML = "";
    store.workoutDays.forEach(d=>{
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      sel.append(opt);
    });
    if(!store.workoutDays.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No days yet";
      sel.append(opt);
    }
    sel.value = store.workoutDays[0]?.id || "";
    fillDayFields(sel.value);
  }
  function fillDayFields(dayId){
    const d = store.workoutDays.find(x=>x.id===dayId);
    if(!d){
      $("dayName").value="";
      $("dayExercises").value="";
      $("dayScheduled").value="yes";
      return;
    }
    $("dayName").value = d.name;
    $("dayScheduled").value = d.scheduled ? "yes" : "no";
    $("dayExercises").value = (d.exercises||[]).join("\n");
  }
  $("daySelect").addEventListener("change", (e)=> fillDayFields(e.target.value));

  $("btnAddDay").addEventListener("click", ()=>{
    const name = prompt("Day name:", "New Day");
    if(!name) return;
    const d = { id: uid(), name: name.trim(), scheduled:false, exercises: [] };
    store.workoutDays.push(d);
    save();
    renderDaysModal();
    toast("Added day");
  });
  $("btnDelDay").addEventListener("click", ()=>{
    const id = $("daySelect").value;
    if(!id) return;
    const d = store.workoutDays.find(x=>x.id===id);
    if(!confirm(`Delete ${d?.name||"this day"}?`)) return;
    store.workoutDays = store.workoutDays.filter(x=>x.id!==id);
    // If active day removed
    if(activeDayId===id){ activeDayId=null; activeEx=null; sessionToday=null; }
    save();
    renderDaysModal();
    renderWorkouts();
    toast("Deleted day");
  });
  $("btnSaveDay").addEventListener("click", ()=>{
    const id = $("daySelect").value;
    const d = store.workoutDays.find(x=>x.id===id);
    if(!d) return;
    d.name = $("dayName").value.trim() || d.name;
    d.scheduled = $("dayScheduled").value==="yes";
    const lines = $("dayExercises").value.split("\n").map(x=>x.trim()).filter(Boolean);
    d.exercises = lines;
    save();
    renderDaysModal();
    renderWorkouts();
    toast("Saved day");
  });

  // --- Meals ---
  function clearMealForm(){
    $("m_date").value = todayISO();
    $("m_title").value = "";
    $("m_cals").value = "";
    $("m_pro").value = "";
    $("m_notes").value = "";
  }
  $("btnClearMeal").addEventListener("click", clearMealForm);

  function renderPresets(){
    const wrap = $("presetPills");
    wrap.innerHTML = "";
    const presets = store.savedMeals || [];
    if(!presets.length){
      const m = document.createElement("div");
      m.className="muted";
      m.textContent="No saved meals yet";
      wrap.append(m);
      return;
    }
    presets.forEach(p=>{
      const el = document.createElement("div");
      el.className="pill";
      el.textContent = p.name;
      // tap = fill
      el.addEventListener("click", ()=>{
        $("m_title").value = p.title || p.name;
        $("m_cals").value = p.calories ?? "";
        $("m_pro").value = p.proteinG ?? "";
        $("m_notes").value = p.notes ?? "";
        toast("Filled meal");
      });
      // long press to delete
      let pressT=null;
      el.addEventListener("touchstart", ()=>{
        pressT = setTimeout(()=>{
          if(confirm(`Delete preset "${p.name}"?`)){
            store.savedMeals = store.savedMeals.filter(x=>x.id!==p.id);
            save();
            renderPresets();
            toast("Deleted preset");
          }
        }, 650);
      }, {passive:true});
      el.addEventListener("touchend", ()=>{ if(pressT) clearTimeout(pressT); pressT=null; }, {passive:true});
      wrap.append(el);
    });
  }

  $("btnSavePreset").addEventListener("click", ()=>{
    const title = $("m_title").value.trim();
    if(!title) return alert("Enter a meal name first.");
    const name = prompt("Save preset as:", title) || "";
    const clean = name.trim();
    if(!clean) return;
    const calories = $("m_cals").value.trim()==="" ? undefined : Number($("m_cals").value);
    const proteinG = $("m_pro").value.trim()==="" ? undefined : Number($("m_pro").value);
    const notes = $("m_notes").value.trim();
    store.savedMeals = store.savedMeals || [];
    // overwrite by name
    store.savedMeals = store.savedMeals.filter(p=>p.name.toLowerCase() !== clean.toLowerCase());
    store.savedMeals.push({ id: uid(), name: clean, title, calories: Number.isFinite(calories)?Math.round(calories):undefined, proteinG:Number.isFinite(proteinG)?Math.round(proteinG):undefined, notes: notes||undefined });
    save();
    renderPresets();
    toast("Saved preset");
  });

  $("btnSaveMeal").addEventListener("click", ()=>{
    const date = $("m_date").value || todayISO();
    const title = $("m_title").value.trim();
    const calories = Number($("m_cals").value);
    const proteinG = Number($("m_pro").value);
    if(!title) return alert("Meal name required.");
    if(!Number.isFinite(calories) && !Number.isFinite(proteinG)) return alert("Enter calories and/or protein.");
    store.meals.unshift({
      id: uid(),
      date,
      title,
      calories: Number.isFinite(calories)?Math.round(calories):0,
      proteinG: Number.isFinite(proteinG)?Math.round(proteinG):0,
      notes: $("m_notes").value.trim() || ""
    });
    save();
    toast("Added meal");
    renderMeals();
    renderDashboard();
    clearMealForm();
  });

  function renderMeals(){
    renderCoach();
    $("m_date").value = $("m_date").value || todayISO();
    renderPresets();

    const t = todayISO();
    const todays = store.meals.filter(m=>m.date===t);
    const totalC = todays.reduce((a,b)=>a+(Number(b.calories)||0),0);
    const totalP = todays.reduce((a,b)=>a+(Number(b.proteinG)||0),0);
    const tC = Number(store.targets.calories||0);
    const left = tC>0 ? (tC - totalC) : 0;
    $("mealsTodayMeta").textContent = tC>0
      ? `Consumed ${totalC} Cal ‚Ä¢ ${Math.max(0,left)} left ‚Ä¢ Protein ${totalP}g`
      : `Consumed ${totalC} Cal ‚Ä¢ Protein ${totalP}g`;

    const list = $("mealsList");
    list.innerHTML = "";
    if(!todays.length){
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `<div class="itemTitle">No meals logged today</div><div class="itemMeta">Add one above</div>`;
      list.append(it);
      return;
    }
    todays.forEach(m=>{
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${m.title}</div>
            <div class="itemMeta">${m.calories||0} Cal ‚Ä¢ ${m.proteinG||0}g protein</div>
          </div>
          <div class="muted">${m.date}</div>
        </div>
        ${m.notes ? `<div class="itemBody">${m.notes}</div>`:""}
        <div class="itemActions">
          <button class="btn" data-edit="${m.id}">Edit</button>
          <button class="btn danger" data-del="${m.id}">Delete</button>
        </div>`;
      list.append(it);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-del");
        store.meals = store.meals.filter(x=>x.id!==id);
        save();
        renderMeals();
        renderDashboard();
        toast("Deleted meal");
      });
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const m = store.meals.find(x=>x.id===id);
        if(!m) return;
        $("m_date").value = m.date;
        $("m_title").value = m.title;
        $("m_cals").value = m.calories ?? "";
        $("m_pro").value = m.proteinG ?? "";
        $("m_notes").value = m.notes ?? "";
        // remove old, re-add on save
        store.meals = store.meals.filter(x=>x.id!==id);
        save();
        toast("Editing ‚Äî press Add to re-save");
        renderMeals();
        renderDashboard();
      });
    });
  }

  // Export/Import
  const openIO = ()=>{ $("importBox").value=""; $("ioModal").classList.add("on"); };
  const closeIO = ()=> $("ioModal").classList.remove("on");
  $("btnExport").addEventListener("click", openIO);
  $("closeIO").addEventListener("click", closeIO);
  $("btnExportJson").addEventListener("click", async ()=>{
    const text = JSON.stringify(store, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      toast("Copied backup JSON");
    }catch(e){
      $("importBox").value = text;
      toast("Copy not allowed ‚Äî shown below");
    }
  });
  $("btnImportJson").addEventListener("click", ()=>{
    const raw = $("importBox").value.trim();
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      store = { ...defaultStore(), ...s };
      save();
      toast("Imported");
      $("ioModal").classList.remove("on");
      setPage("dashboard");
    }catch(e){
      alert("Invalid JSON");
    }
  });

  // --- Weight ---
  function renderWeight(){
    $("w_date").value = $("w_date").value || todayISO();
    const list = $("weightList");
    list.innerHTML = "";
    const sorted = store.weights.slice().sort((a,b)=>a.date<b.date?1:-1);
    sorted.slice(0,20).forEach(w=>{
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${Number(w.kg).toFixed(1)} kg</div>
            <div class="itemMeta">${w.date}</div>
          </div>
          <button class="btn danger" data-del="${w.id}">Delete</button>
        </div>
        ${w.notes?`<div class="itemBody">${w.notes}</div>`:""}`;
      list.append(it);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-del");
        store.weights = store.weights.filter(x=>x.id!==id);
        save();
        renderWeight();
        renderDashboard();
        toast("Deleted weigh-in");
      });
    });
  }
  $("btnSaveWeight").addEventListener("click", ()=>{
    const date = $("w_date").value || todayISO();
    const kg = Number($("w_kg").value);
    if(!Number.isFinite(kg) || kg<=0) return alert("Enter a valid weight.");
    store.weights.unshift({ id: uid(), date, kg: Number(kg.toFixed(1)), notes: $("w_notes").value.trim()||"" });
    save();
    toast("Added weigh-in");
    renderWeight();
    renderDashboard();
    $("w_kg").value=""; $("w_notes").value="";
  });
  $("btnClearWeight").addEventListener("click", ()=>{ $("w_kg").value=""; $("w_notes").value=""; });

  // --- Steps ---
  function renderSteps(){
    $("s_date").value = $("s_date").value || todayISO();
    const list = $("stepsList");
    list.innerHTML="";
    const sorted = store.steps.slice().sort((a,b)=>a.date<b.date?1:-1);
    sorted.slice(0,30).forEach(s=>{
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${s.steps} steps</div>
            <div class="itemMeta">${s.date}</div>
          </div>
          <div class="itemActions">
            <button class="btn" data-edit="${s.id}">Edit</button>
            <button class="btn danger" data-del="${s.id}">Delete</button>
          </div>
        </div>`;
      list.append(it);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-del");
        store.steps = store.steps.filter(x=>x.id!==id);
        save();
        renderSteps();
        renderDashboard();
        toast("Deleted steps");
      });
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const s = store.steps.find(x=>x.id===id);
        if(!s) return;
        $("s_date").value = s.date;
        $("s_steps").value = s.steps;
        store.steps = store.steps.filter(x=>x.id!==id);
        save();
        toast("Editing ‚Äî press Add to re-save");
        renderSteps();
      });
    });
  }
  $("btnSaveSteps").addEventListener("click", ()=>{
    const date = $("s_date").value || todayISO();
    const steps = Number($("s_steps").value);
    if(!Number.isFinite(steps) || steps<0) return alert("Enter valid steps.");
    store.steps.unshift({ id: uid(), date, steps: Math.round(steps) });
    save();
    toast("Saved steps");
    renderSteps();
    renderDashboard();
    $("s_steps").value="";
  });
  $("btnClearSteps").addEventListener("click", ()=>{ $("s_steps").value=""; });

  // --- Cardio ---
  const parseTime = (t) => {
    const s = String(t||"").trim();
    if(!s) return null;
    const parts = s.split(":");
    if(parts.length===1){
      const m = Number(parts[0]); return Number.isFinite(m)?Math.round(m*60):null;
    }
    if(parts.length===2){
      const m = Number(parts[0]), sec = Number(parts[1]);
      if(!Number.isFinite(m)||!Number.isFinite(sec)) return null;
      return Math.round(m*60+sec);
    }
    return null;
  };
  const paceStr = (secPerKm) => {
    if(!Number.isFinite(secPerKm) || secPerKm<=0) return "‚Äî";
    const m = Math.floor(secPerKm/60);
    const s = Math.round(secPerKm%60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}/km`;
  };
  function renderCardio(){
    $("c_date").value = $("c_date").value || todayISO();
    const list = $("cardioList");
    list.innerHTML="";
    const sorted = store.cardio.slice().sort((a,b)=>a.date<b.date?1:-1);
    sorted.slice(0,30).forEach(c=>{
      const km = Number(c.km)||0;
      const sec = Number(c.sec)||0;
      const pace = (km>0 && sec>0) ? paceStr(sec/km) : "‚Äî";
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${c.type} ‚Ä¢ ${km.toFixed(2)} km</div>
            <div class="itemMeta">${c.date} ‚Ä¢ ${c.time||"‚Äî"} ‚Ä¢ Pace ${pace}</div>
          </div>
          <div class="itemActions">
            <button class="btn" data-edit="${c.id}">Edit</button>
            <button class="btn danger" data-del="${c.id}">Delete</button>
          </div>
        </div>
        ${c.notes?`<div class="itemBody">${c.notes}</div>`:""}
      `;
      list.append(it);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-del");
        store.cardio = store.cardio.filter(x=>x.id!==id);
        save();
        renderCardio();
        renderDashboard();
        toast("Deleted cardio");
      });
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const c = store.cardio.find(x=>x.id===id);
        if(!c) return;
        $("c_date").value = c.date;
        $("c_type").value = c.type;
        $("c_km").value = c.km;
        $("c_time").value = c.time;
        $("c_notes").value = c.notes || "";
        store.cardio = store.cardio.filter(x=>x.id!==id);
        save();
        toast("Editing ‚Äî press Add to re-save");
        renderCardio();
      });
    });
  }
  $("btnSaveCardio").addEventListener("click", ()=>{
    const date = $("c_date").value || todayISO();
    const type = $("c_type").value || "Run";
    const km = Number($("c_km").value);
    const time = $("c_time").value.trim();
    if(!Number.isFinite(km) || km<=0) return alert("Enter a valid distance (km).");
    const sec = parseTime(time);
    if(time && sec==null) return alert("Time should be like 25:30");
    store.cardio.unshift({ id: uid(), date, type, km: Number(km.toFixed(2)), time, sec: sec||0, notes: $("c_notes").value.trim()||"" });
    save();
    toast("Saved cardio");
    renderCardio();
    renderDashboard();
    $("c_km").value=""; $("c_time").value=""; $("c_notes").value="";
  });
  $("btnClearCardio").addEventListener("click", ()=>{ $("c_km").value=""; $("c_time").value=""; $("c_notes").value=""; });

  // --- Progress ---
  function renderProgress(){
    $("p_date").value = $("p_date").value || todayISO();
    const list = $("progList");
    list.innerHTML="";
    const sorted = store.progress.slice().sort((a,b)=>a.date<b.date?1:-1);
    sorted.slice(0,30).forEach(p=>{
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${p.date}</div>
            <div class="itemMeta">${p.waist?`Waist ${p.waist} cm ‚Ä¢ `:""}Entry</div>
          </div>
          <div class="itemActions">
            <button class="btn" data-edit="${p.id}">Edit</button>
            <button class="btn danger" data-del="${p.id}">Delete</button>
          </div>
        </div>
        ${p.notes?`<div class="itemBody">${p.notes}</div>`:""}
      `;
      list.append(it);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-del");
        store.progress = store.progress.filter(x=>x.id!==id);
        save();
        renderProgress();
        renderDashboard();
        toast("Deleted entry");
      });
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        const p = store.progress.find(x=>x.id===id);
        if(!p) return;
        $("p_date").value = p.date;
        $("p_waist").value = p.waist ?? "";
        $("p_notes").value = p.notes ?? "";
        store.progress = store.progress.filter(x=>x.id!==id);
        save();
        toast("Editing ‚Äî press Add to re-save");
        renderProgress();
      });
    });
  }
  $("btnSaveProg").addEventListener("click", ()=>{
    const date = $("p_date").value || todayISO();
    const waistVal = $("p_waist").value.trim()==="" ? undefined : Number($("p_waist").value);
    const notes = $("p_notes").value.trim();
    if(!notes && !Number.isFinite(waistVal)) return alert("Add notes and/or waist.");
    store.progress.unshift({ id: uid(), date, waist: Number.isFinite(waistVal)?Number(waistVal.toFixed(1)):undefined, notes });
    save();
    toast("Saved progress");
    renderProgress();
    renderDashboard();
    $("p_waist").value=""; $("p_notes").value="";
  });
  $("btnClearProg").addEventListener("click", ()=>{ $("p_waist").value=""; $("p_notes").value=""; });

  // Close modals on background tap
  ["settingsModal","daysModal","ioModal"].forEach(mid=>{
    const m = $(mid);
    m.addEventListener("click", (e)=>{
      if(e.target===m) m.classList.remove("on");
    });
  });

  // Init defaults for date fields
  ["m_date","w_date","s_date","c_date","p_date"].forEach(id=>{
    const el = $(id);
    if(el) el.value = todayISO();
  });
  // Load coach notes
  renderCoach();
  // First render
  renderDashboard();

  // Service worker
  if("serviceWorker" in navigator){
    window.addEventListener("load", ()=>{
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
})();
</script>
</body>
</html>
